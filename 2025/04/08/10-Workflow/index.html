<!DOCTYPE HTML>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="10-Workflow, Blog">
    <meta name="description" content="1 工作流的重要性1.1 影响大模型应用效果的因素
模型能力（智力）
通识理解和泛化能力
输入信息理解、推理、规划、执行能力
输入信息补充知识学习能力
文字生成创作的风格


相关信息（知识）
与任务相关的信息
与互动背景相关的信息


模">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>10-Workflow | Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Index</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>Archives</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>Contact</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="Search" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Index
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			Archives
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			Contact
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/TangCharlotte/AI-Classes" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/TangCharlotte/AI-Classes" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/13.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">10-Workflow</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/LLM/">
                                <span class="chip bg-color">LLM</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>Publish Date:&nbsp;&nbsp;
                    2025-04-08
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        
        <!-- 代码块折行 -->
        <style type="text/css">
            code[class*="language-"], pre[class*="language-"] { white-space: pre-wrap !important; }
        </style>
        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-工作流的重要性"><a href="#1-工作流的重要性" class="headerlink" title="1 工作流的重要性"></a>1 工作流的重要性</h2><h3 id="1-1-影响大模型应用效果的因素"><a href="#1-1-影响大模型应用效果的因素" class="headerlink" title="1.1 影响大模型应用效果的因素"></a>1.1 影响大模型应用效果的因素</h3><ul>
<li>模型能力（智力）<ul>
<li>通识理解和泛化能力</li>
<li>输入信息理解、推理、规划、执行能力</li>
<li>输入信息补充知识学习能力</li>
<li>文字生成创作的风格</li>
</ul>
</li>
<li>相关信息（知识）<ul>
<li>与任务相关的信息</li>
<li>与互动背景相关的信息</li>
</ul>
</li>
<li>模型输出控制（行动方法）<ul>
<li>单次请求控制<ul>
<li>Prompt表达优化</li>
<li>以CoT为代表的思维链控制方法</li>
<li>输出格式控制（文本格式语法、工程结构化数据输出…）</li>
</ul>
</li>
<li>多次请求控制<ul>
<li>以ReAct（Action-Observation-Reflection）为代表的多轮自我反思优化</li>
<li>复杂任务的执行过程编排管理</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="1-2-单次请求的局限性"><a href="#1-2-单次请求的局限性" class="headerlink" title="1.2 单次请求的局限性"></a>1.2 单次请求的局限性</h3><ul>
<li>上下文窗口长度限制、输出长度限制（早期的LangChain长文本Summarize）</li>
<li>直接进行CoT控制（尤其是用自然语言表达CoT）会输出思考过程，但我们不希望用户看到这个过程</li>
<li>随着工作进展出现的新信息，对任务时序、编排有依赖的信息，不一定能在单次请求中一次性完成输入</li>
</ul>
<h3 id="1-3-工作流的优势"><a href="#1-3-工作流的优势" class="headerlink" title="1.3 工作流的优势"></a>1.3 工作流的优势</h3><ul>
<li>将工作任务拆分成多个工作节点</li>
<li>能够将模型单次请求调用视作一个工作节点</li>
<li>能够灵活将其他代码逻辑也写入工作节点</li>
<li>能够对工作节点进行任务编排</li>
<li>能够在工作节点之间进行数据传递</li>
</ul>
<p>直接请求模型的效果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清理环境信息，与上课内容无关</span></span><br><span class="line"><span class="string">import</span> <span class="string">os</span></span><br><span class="line"><span class="string">os.environ[&quot;LANGCHAIN_PROJECT&quot;]</span> <span class="string">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="string">os.environ[&quot;LANGCHAIN_API_KEY&quot;]</span> <span class="string">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="string">os.environ[&quot;LANGCHAIN_ENDPOINT&quot;]</span> <span class="string">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="string">os.environ[&quot;LANGCHAIN_TRACING_V2&quot;]</span> <span class="string">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装所需要使用的包</span></span><br><span class="line"><span class="type">!pip</span> <span class="string">install</span> <span class="string">openai</span> <span class="string">langgraph</span> <span class="string">Agently==3.3.4.5</span> <span class="string">mermaid-python</span> <span class="string">nest_asyncio</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为本课使用的langgraph可能需要依赖langchain 0.2.10版本，但其他课件依赖langchain 0.1.20版本</span></span><br><span class="line"><span class="comment"># 请学习完本课之后对langchain进行降级，以免在其他课程出现运行错误</span></span><br><span class="line"><span class="comment">#!pip install langchain==0.1.20</span></span><br><span class="line"><span class="comment">#!pip install langchain-openai==0.1.6</span></span><br><span class="line"><span class="comment">#!pip install langchain-community==0.0.38</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用nest_asyncio确保异步稳定性</span></span><br><span class="line"><span class="string">import</span> <span class="string">nest_asyncio</span></span><br><span class="line"><span class="string">nest_asyncio.apply()</span></span><br><span class="line"></span><br><span class="line"><span class="string">from</span> <span class="string">ENV</span> <span class="string">import</span> <span class="string">deep_seek_url,</span> <span class="string">deep_seek_api_key,</span> <span class="string">deep_seek_default_model</span></span><br><span class="line"><span class="string">import</span> <span class="string">Agently</span></span><br><span class="line"><span class="string">agent</span> <span class="string">=</span> <span class="string">(</span></span><br><span class="line">    <span class="string">Agently.create_agent()</span></span><br><span class="line">        <span class="string">.set_settings(&quot;current_model&quot;,</span> <span class="string">&quot;OAIClient&quot;</span><span class="string">)</span></span><br><span class="line">        <span class="string">.set_settings(&quot;model.OAIClient.url&quot;,</span> <span class="string">deep_seek_url)</span></span><br><span class="line">        <span class="string">.set_settings(&quot;model.OAIClient.auth&quot;,</span> &#123; <span class="attr">&quot;api_key&quot;:</span> <span class="string">deep_seek_api_key</span> &#125;<span class="string">)</span></span><br><span class="line">        <span class="string">.set_settings(&quot;model.OAIClient.options&quot;,</span> &#123; <span class="attr">&quot;model&quot;:</span> <span class="string">deep_seek_default_model</span> &#125;<span class="string">)</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"></span><br><span class="line"><span class="string">result</span> <span class="string">=</span> <span class="string">agent.input(input(&quot;[请输入您的要求]:</span> <span class="string">&quot;)).start()</span></span><br><span class="line"><span class="string">print(&quot;</span>[<span class="string">回复</span>]<span class="string">:</span> <span class="string">&quot;, result)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li><p><strong>检查退货政策</strong>：首先，查看您购买时的退货政策。大多数零售商都有一定的退货期限，通常是购买后的30天内。确保您的退货请求在期限内。</p>
</li>
<li><p><strong>保留收据和包装</strong>：保留您的购买收据和鞋子的原始包装。这些通常是退货时必需的。</p>
</li>
<li><p><strong>联系客服</strong>：通过电话、电子邮件或在线聊天联系零售商的客服部门。说明您的情况，并询问退货流程。</p>
</li>
<li><p><strong>准备退货物品</strong>：按照零售商的要求准备退货物品。可能需要您将鞋子放回原始包装中，并附上收据。</p>
</li>
<li><p><strong>退货方式</strong>：根据零售商的指示，您可能需要亲自到店铺退货，或者通过邮寄的方式退货。如果是邮寄，确保使用可追踪的邮寄服务，并保留邮寄凭证。</p>
</li>
<li><p><strong>等待处理</strong>：一旦零售商收到您的退货物品，他们将进行检查并处理退款。退款通常会退回到您原支付方式中。</p>
</li>
<li><p><strong>跟进</strong>：如果在合理的时间内没有收到退款，及时跟进并联系客服询问退款状态。</p>
</li>
</ol>
<p>请注意，不同的零售商可能有不同的退货政策和流程，所以最好是直接咨询您购买鞋子的零售商以获取最准确的信息。如果是在线购买，通常可以在网站的“帮助”或“客户服务”部分找到退货指南。</p>
</blockquote>
<p>使用工作流：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">workflow = Agently.Workflow()</span><br><span class="line"></span><br><span class="line"><span class="meta">@workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_input</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;user_input&quot;</span>, <span class="built_in">input</span>(<span class="string">&quot;[请输入您的要求]: &quot;</span>))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">judge_intent_and_quick_reply</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    result = (</span><br><span class="line">        agent</span><br><span class="line">            .<span class="built_in">input</span>(storage.get(<span class="string">&quot;user_input&quot;</span>))</span><br><span class="line">            .output(&#123;</span><br><span class="line">                <span class="string">&quot;user_intent&quot;</span>: (<span class="string">&quot;闲聊 | 售后问题 | 其他&quot;</span>, <span class="string">&quot;判断用户提交的&#123;input&#125;内容属于给定选项中的哪一种&quot;</span>),</span><br><span class="line">                <span class="string">&quot;quick_reply&quot;</span>: (</span><br><span class="line">                    <span class="string">&quot;str&quot;</span>,</span><br><span class="line"><span class="string">&quot;&quot;&quot;如果&#123;user_intent&#125;==&#x27;闲聊&#x27;，那么直接给出你的回应；</span></span><br><span class="line"><span class="string">如果&#123;user_intent&#125;==&#x27;售后问题&#x27;，那么请用合适的方式告诉用户你已经明白用户的诉求，安抚客户情绪并请稍等你去看看应该如何处理；</span></span><br><span class="line"><span class="string">如果&#123;user_intent&#125;==&#x27;其他&#x27;，此项输出null&quot;&quot;&quot;</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">            .start()</span><br><span class="line">    )</span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;reply&quot;</span>, result[<span class="string">&quot;quick_reply&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> result[<span class="string">&quot;user_intent&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="meta">@workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_after_sales_reply</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;reply&quot;</span>, (</span><br><span class="line">        agent</span><br><span class="line">            .<span class="built_in">input</span>(storage.get(<span class="string">&quot;user_input&quot;</span>))</span><br><span class="line">            .instruct(</span><br><span class="line"><span class="string">&quot;&quot;&quot;请根据&#123;input&#125;的要求，以一个专业客户服务人员的角色给出回复，遵循如下模板进行回复：</span></span><br><span class="line"><span class="string">亲爱的客户，感谢您的耐心等待。</span></span><br><span class="line"><span class="string">我理解您希望&#123;&#123;复述客户的要求&#125;&#125;，是因为&#123;&#123;复述客户要求提出要求的理由&#125;&#125;，您的心情一定非常&#123;&#123;阐述你对客户心情/感受的理解&#125;&#125;。</span></span><br><span class="line"><span class="string">&#123;&#123;给出对客户当前心情的抚慰性话语&#125;&#125;。</span></span><br><span class="line"><span class="string">我们会尽快和相关人员沟通，并尽量进行满足。请留下您的联系方式以方便我们尽快处理后与您联系。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">)</span><br><span class="line">            .start()</span><br><span class="line">    ))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_other_topic_reply</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;reply&quot;</span>, <span class="string">&quot;我们好像不应该聊这个，还是回到您的问题或诉求上来吧。&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@workflow.chunk_class()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reply</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[回复]: &quot;</span>, storage.get(<span class="string">&quot;reply&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">(</span><br><span class="line">    workflow</span><br><span class="line">        .connect_to(<span class="string">&quot;user_input&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;judge_intent_and_quick_reply&quot;</span>)</span><br><span class="line">        .if_condition(<span class="keyword">lambda</span> return_value, storage: return_value==<span class="string">&quot;闲聊&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;@reply&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">        .elif_condition(<span class="keyword">lambda</span> return_value, storage: return_value==<span class="string">&quot;售后问题&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;@reply&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;generate_after_sales_reply&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;@reply&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;user_input&quot;</span>)</span><br><span class="line">        .else_condition()</span><br><span class="line">            .connect_to(<span class="string">&quot;generate_other_topic_reply&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;@reply&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;END&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">workflow.start()</span><br><span class="line"><span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>我理解您希望退货，是因为鞋子不合脚，您的心情一定非常失望。</p>
<p>请不要担心，我们会尽力帮助您解决这个问题。我们会尽快和相关人员沟通，并尽量进行满足。请留下您的联系方式以方便我们尽快处理后与您联系。</p>
</blockquote>
<img src="/2025/04/08/10-Workflow/1744165045395-7.png" class="">

<h2 id="2-吴恩达博士的开源翻译工作流项目"><a href="#2-吴恩达博士的开源翻译工作流项目" class="headerlink" title="2 吴恩达博士的开源翻译工作流项目"></a>2 吴恩达博士的开源翻译工作流项目</h2><ul>
<li>项目地址：<a target="_blank" rel="noopener" href="https://github.com/andrewyng/translation-agent">https://github.com/andrewyng/translation-agent</a></li>
<li>项目基本思路：<ul>
<li>让模型在完成首轮翻译之后，通过自我反思后修正的工作流优化翻译结果，以提升最终文本翻译的质量</li>
</ul>
</li>
<li>关键步骤：<ul>
<li>第一步：<ol>
<li>输入信息：<strong>原始****文本语言(source_lang)</strong> 、<strong>翻译目标语言(target_lang)</strong> 和 <strong>原始文本(source_text)</strong></li>
<li>角色设定：以翻译文本为任务目标的语言学家</li>
<li>输出结果：基于所有输入信息，对 <strong>原始文本(source_text)</strong> 进行 **第一轮翻译的结果(translation_1)**；</li>
</ol>
</li>
<li>第二步：<ol>
<li>输入信息：<strong>原始文本语言(source_lang)</strong> 、<strong>翻译目标语言(target_lang)</strong> 、 <strong>原始文本(source_text)</strong> 和 <strong>第一轮翻译结果(translation_1)</strong></li>
<li>角色设定：以阅读原始文本和翻译文本，并给出翻译改进意见为任务目标的语言学家</li>
<li>输出结果：基于所有输入信息，对 <strong>第一轮翻译结果(translation_1)</strong> 提出的 <strong>改进意见反思(reflection)</strong></li>
</ol>
</li>
<li>第三步：<ol>
<li>输入信息：<strong>原始文本语言(source_lang)</strong> 、<strong>翻译目标语言(target_lang)</strong> 、 <strong>原始文本(source_text)</strong> 、 <strong>第一轮翻译结果(translation_1)</strong> 和 <strong>改进意见反思(reflection)</strong></li>
<li>角色设定：以翻译文本为任务目标的语言学家（和第一步相同）</li>
<li>输出结果：基于所有输入信息，给出的<strong>第二轮优化后翻译结果(translation_2)</strong></li>
</ol>
</li>
</ul>
</li>
<li>关键代码文件：<a target="_blank" rel="noopener" href="https://github.com/andrewyng/translation-agent/blob/main/src/translation_agent/utils.py">https://github.com/andrewyng/translation-agent/blob/main/src/translation_agent/utils.py</a></li>
<li>关键代码片段：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">one_chunk_initial_translation</span>(<span class="params"></span></span><br><span class="line"><span class="params">    source_lang: <span class="built_in">str</span>, target_lang: <span class="built_in">str</span>, source_text: <span class="built_in">str</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Translate the entire text as one chunk using an LLM.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        source_lang (str): The source language of the text.</span></span><br><span class="line"><span class="string">        target_lang (str): The target language for translation.</span></span><br><span class="line"><span class="string">        source_text (str): The text to be translated.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        str: The translated text.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    system_message = <span class="string">f&quot;You are an expert linguist, specializing in translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>.&quot;</span></span><br><span class="line"></span><br><span class="line">    translation_prompt = <span class="string">f&quot;&quot;&quot;This is an <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span> translation, please provide the <span class="subst">&#123;target_lang&#125;</span> translation for this text. \</span></span><br><span class="line"><span class="string">Do not provide any explanations or text apart from the translation.</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_lang&#125;</span>: <span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;target_lang&#125;</span>:&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    prompt = translation_prompt.<span class="built_in">format</span>(source_text=source_text)</span><br><span class="line"></span><br><span class="line">    translation = get_completion(prompt, system_message=system_message)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> translation</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one_chunk_reflect_on_translation</span>(<span class="params"></span></span><br><span class="line"><span class="params">    source_lang: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    target_lang: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    source_text: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    translation_1: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    country: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Use an LLM to reflect on the translation, treating the entire text as one chunk.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        source_lang (str): The source language of the text.</span></span><br><span class="line"><span class="string">        target_lang (str): The target language of the translation.</span></span><br><span class="line"><span class="string">        source_text (str): The original text in the source language.</span></span><br><span class="line"><span class="string">        translation_1 (str): The initial translation of the source text.</span></span><br><span class="line"><span class="string">        country (str): Country specified for target language.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        str: The LLM&#x27;s reflection on the translation, providing constructive criticism and suggestions for improvement.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    system_message = <span class="string">f&quot;You are an expert linguist specializing in translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>. \</span></span><br><span class="line"><span class="string">You will be provided with a source text and its translation and your goal is to improve the translation.&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> country != <span class="string">&quot;&quot;</span>:</span><br><span class="line">        reflection_prompt = <span class="string">f&quot;&quot;&quot;Your task is to carefully read a source text and a translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>, and then give constructive criticism and helpful suggestions to improve the translation. \</span></span><br><span class="line"><span class="string">The final style and tone of the translation should match the style of <span class="subst">&#123;target_lang&#125;</span> colloquially spoken in <span class="subst">&#123;country&#125;</span>.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The source text and initial translation, delimited by XML tags &lt;SOURCE_TEXT&gt;&lt;/SOURCE_TEXT&gt; and &lt;TRANSLATION&gt;&lt;/TRANSLATION&gt;, are as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string">&lt;/SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;TRANSLATION&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;translation_1&#125;</span></span></span><br><span class="line"><span class="string">&lt;/TRANSLATION&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">When writing suggestions, pay attention to whether there are ways to improve the translation&#x27;s \n\</span></span><br><span class="line"><span class="string">(i) accuracy (by correcting errors of addition, mistranslation, omission, or untranslated text),\n\</span></span><br><span class="line"><span class="string">(ii) fluency (by applying <span class="subst">&#123;target_lang&#125;</span> grammar, spelling and punctuation rules, and ensuring there are no unnecessary repetitions),\n\</span></span><br><span class="line"><span class="string">(iii) style (by ensuring the translations reflect the style of the source text and takes into account any cultural context),\n\</span></span><br><span class="line"><span class="string">(iv) terminology (by ensuring terminology use is consistent and reflects the source text domain; and by only ensuring you use equivalent idioms <span class="subst">&#123;target_lang&#125;</span>).\n\</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write a list of specific, helpful and constructive suggestions for improving the translation.</span></span><br><span class="line"><span class="string">Each suggestion should address one specific part of the translation.</span></span><br><span class="line"><span class="string">Output only the suggestions and nothing else.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        reflection_prompt = <span class="string">f&quot;&quot;&quot;Your task is to carefully read a source text and a translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>, and then give constructive criticism and helpful suggestions to improve the translation. \</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The source text and initial translation, delimited by XML tags &lt;SOURCE_TEXT&gt;&lt;/SOURCE_TEXT&gt; and &lt;TRANSLATION&gt;&lt;/TRANSLATION&gt;, are as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string">&lt;/SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;TRANSLATION&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;translation_1&#125;</span></span></span><br><span class="line"><span class="string">&lt;/TRANSLATION&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">When writing suggestions, pay attention to whether there are ways to improve the translation&#x27;s \n\</span></span><br><span class="line"><span class="string">(i) accuracy (by correcting errors of addition, mistranslation, omission, or untranslated text),\n\</span></span><br><span class="line"><span class="string">(ii) fluency (by applying <span class="subst">&#123;target_lang&#125;</span> grammar, spelling and punctuation rules, and ensuring there are no unnecessary repetitions),\n\</span></span><br><span class="line"><span class="string">(iii) style (by ensuring the translations reflect the style of the source text and takes into account any cultural context),\n\</span></span><br><span class="line"><span class="string">(iv) terminology (by ensuring terminology use is consistent and reflects the source text domain; and by only ensuring you use equivalent idioms <span class="subst">&#123;target_lang&#125;</span>).\n\</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write a list of specific, helpful and constructive suggestions for improving the translation.</span></span><br><span class="line"><span class="string">Each suggestion should address one specific part of the translation.</span></span><br><span class="line"><span class="string">Output only the suggestions and nothing else.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    prompt = reflection_prompt.<span class="built_in">format</span>(</span><br><span class="line">        source_lang=source_lang,</span><br><span class="line">        target_lang=target_lang,</span><br><span class="line">        source_text=source_text,</span><br><span class="line">        translation_1=translation_1,</span><br><span class="line">    )</span><br><span class="line">    reflection = get_completion(prompt, system_message=system_message)</span><br><span class="line">    <span class="keyword">return</span> reflection</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one_chunk_improve_translation</span>(<span class="params"></span></span><br><span class="line"><span class="params">    source_lang: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    target_lang: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    source_text: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    translation_1: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    reflection: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Use the reflection to improve the translation, treating the entire text as one chunk.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        source_lang (str): The source language of the text.</span></span><br><span class="line"><span class="string">        target_lang (str): The target language for the translation.</span></span><br><span class="line"><span class="string">        source_text (str): The original text in the source language.</span></span><br><span class="line"><span class="string">        translation_1 (str): The initial translation of the source text.</span></span><br><span class="line"><span class="string">        reflection (str): Expert suggestions and constructive criticism for improving the translation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        str: The improved translation based on the expert suggestions.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    system_message = <span class="string">f&quot;You are an expert linguist, specializing in translation editing from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>.&quot;</span></span><br><span class="line"></span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;Your task is to carefully read, then edit, a translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>, taking into</span></span><br><span class="line"><span class="string">account a list of expert suggestions and constructive criticisms.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The source text, the initial translation, and the expert linguist suggestions are delimited by XML tags &lt;SOURCE_TEXT&gt;&lt;/SOURCE_TEXT&gt;, &lt;TRANSLATION&gt;&lt;/TRANSLATION&gt; and &lt;EXPERT_SUGGESTIONS&gt;&lt;/EXPERT_SUGGESTIONS&gt; \</span></span><br><span class="line"><span class="string">as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string">&lt;/SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;TRANSLATION&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;translation_1&#125;</span></span></span><br><span class="line"><span class="string">&lt;/TRANSLATION&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;EXPERT_SUGGESTIONS&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;reflection&#125;</span></span></span><br><span class="line"><span class="string">&lt;/EXPERT_SUGGESTIONS&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please take into account the expert suggestions when editing the translation. Edit the translation by ensuring:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(i) accuracy (by correcting errors of addition, mistranslation, omission, or untranslated text),</span></span><br><span class="line"><span class="string">(ii) fluency (by applying <span class="subst">&#123;target_lang&#125;</span> grammar, spelling and punctuation rules and ensuring there are no unnecessary repetitions), \</span></span><br><span class="line"><span class="string">(iii) style (by ensuring the translations reflect the style of the source text)</span></span><br><span class="line"><span class="string">(iv) terminology (inappropriate for context, inconsistent use), or</span></span><br><span class="line"><span class="string">(v) other errors.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Output only the new translation and nothing else.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    translation_2 = get_completion(prompt, system_message)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> translation_2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">one_chunk_translate_text</span>(<span class="params"></span></span><br><span class="line"><span class="params">    source_lang: <span class="built_in">str</span>, target_lang: <span class="built_in">str</span>, source_text: <span class="built_in">str</span>, country: <span class="built_in">str</span> = <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Translate a single chunk of text from the source language to the target language.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    This function performs a two-step translation process:</span></span><br><span class="line"><span class="string">    1. Get an initial translation of the source text.</span></span><br><span class="line"><span class="string">    2. Reflect on the initial translation and generate an improved translation.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        source_lang (str): The source language of the text.</span></span><br><span class="line"><span class="string">        target_lang (str): The target language for the translation.</span></span><br><span class="line"><span class="string">        source_text (str): The text to be translated.</span></span><br><span class="line"><span class="string">        country (str): Country specified for target language.</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        str: The improved translation of the source text.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    translation_1 = one_chunk_initial_translation(</span><br><span class="line">        source_lang, target_lang, source_text</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    reflection = one_chunk_reflect_on_translation(</span><br><span class="line">        source_lang, target_lang, source_text, translation_1, country</span><br><span class="line">    )</span><br><span class="line">    translation_2 = one_chunk_improve_translation(</span><br><span class="line">        source_lang, target_lang, source_text, translation_1, reflection</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> translation_2</span><br></pre></td></tr></table></figure>

<h2 id="3-使用LangGraph和Agently-Workflow分别复现工作流"><a href="#3-使用LangGraph和Agently-Workflow分别复现工作流" class="headerlink" title="3 使用LangGraph和Agently Workflow分别复现工作流"></a>3 使用LangGraph和Agently Workflow分别复现工作流</h2><h3 id="3-1-LangGraph"><a href="#3-1-LangGraph" class="headerlink" title="3.1 LangGraph"></a>3.1 LangGraph</h3><p>LangGraph手册：<a target="_blank" rel="noopener" href="https://langchain-ai.github.io/langgraph/">https://langchain-ai.github.io/langgraph/</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> openai</span><br><span class="line"><span class="keyword">from</span> ENV <span class="keyword">import</span> deep_seek_url, deep_seek_api_key, deep_seek_default_model</span><br><span class="line"><span class="keyword">from</span> langgraph.graph <span class="keyword">import</span> StateGraph, START, END</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型请求准备</span></span><br><span class="line">client = openai.OpenAI(</span><br><span class="line">    api_key = deep_seek_api_key,</span><br><span class="line">    base_url =deep_seek_url</span><br><span class="line">)</span><br><span class="line">default_model = deep_seek_default_model</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_completion</span>(<span class="params"></span></span><br><span class="line"><span class="params">    prompt: <span class="built_in">str</span>,</span></span><br><span class="line"><span class="params">    system_message: <span class="built_in">str</span> = <span class="string">&quot;You are a helpful assistant.&quot;</span>,</span></span><br><span class="line"><span class="params">    model: <span class="built_in">str</span> = default_model,</span></span><br><span class="line"><span class="params">    temperature: <span class="built_in">float</span> = <span class="number">0.3</span>,</span></span><br><span class="line"><span class="params">    json_mode: <span class="built_in">bool</span> = <span class="literal">False</span>,</span></span><br><span class="line"><span class="params"></span>):</span><br><span class="line">    response = client.chat.completions.create(</span><br><span class="line">        model=model,</span><br><span class="line">        temperature=temperature,</span><br><span class="line">        top_p=<span class="number">1</span>,</span><br><span class="line">        messages=[</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;system&quot;</span>, <span class="string">&quot;content&quot;</span>: system_message&#125;,</span><br><span class="line">            &#123;<span class="string">&quot;role&quot;</span>: <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>: prompt&#125;,</span><br><span class="line">        ],</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> response.choices[<span class="number">0</span>].message.content</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义传递的信息结构</span></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> TypedDict, <span class="type">Optional</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">State</span>(<span class="title class_ inherited__">TypedDict</span>):</span><br><span class="line">    source_lang: <span class="built_in">str</span></span><br><span class="line">    target_lang: <span class="built_in">str</span></span><br><span class="line">    source_text: <span class="built_in">str</span></span><br><span class="line">    country: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    translation_1: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    reflection: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line">    translation_2: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个工作流对象</span></span><br><span class="line">workflow = StateGraph(State)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义三个工作块</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">获取state中的信息：state.get(&quot;key_name&quot;)</span></span><br><span class="line"><span class="string">更新state中的信息：return &#123; &quot;key_name&quot;: new_value &#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initial_translation</span>(<span class="params">state</span>):</span><br><span class="line">    source_lang = state.get(<span class="string">&quot;source_lang&quot;</span>)</span><br><span class="line">    target_lang = state.get(<span class="string">&quot;target_lang&quot;</span>)</span><br><span class="line">    source_text = state.get(<span class="string">&quot;source_text&quot;</span>)</span><br><span class="line"></span><br><span class="line">    system_message = <span class="string">f&quot;You are an expert linguist, specializing in translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>.&quot;</span></span><br><span class="line"></span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;This is an <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span> translation, please provide the <span class="subst">&#123;target_lang&#125;</span> translation for this text. \</span></span><br><span class="line"><span class="string">Do not provide any explanations or text apart from the translation.</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_lang&#125;</span>: <span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;target_lang&#125;</span>:&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    translation = get_completion(prompt, system_message=system_message)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[初次翻译结果]: \n&quot;</span>, translation)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="string">&quot;translation_1&quot;</span>: translation &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reflect_on_translation</span>(<span class="params">state</span>):</span><br><span class="line">    source_lang = state.get(<span class="string">&quot;source_lang&quot;</span>)</span><br><span class="line">    target_lang = state.get(<span class="string">&quot;target_lang&quot;</span>)</span><br><span class="line">    source_text = state.get(<span class="string">&quot;source_text&quot;</span>)</span><br><span class="line">    country = state.get(<span class="string">&quot;country&quot;</span>) <span class="keyword">or</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    translation_1 = state.get(<span class="string">&quot;translation_1&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    system_message = <span class="string">f&quot;You are an expert linguist specializing in translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>. \</span></span><br><span class="line"><span class="string">You will be provided with a source text and its translation and your goal is to improve the translation.&quot;</span></span><br><span class="line"></span><br><span class="line">    additional_rule = (</span><br><span class="line">        <span class="string">f&quot;The final style and tone of the translation should match the style of <span class="subst">&#123;target_lang&#125;</span> colloquially spoken in <span class="subst">&#123;country&#125;</span>.&quot;</span></span><br><span class="line">        <span class="keyword">if</span> country != <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;Your task is to carefully read a source text and a translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>, and then give constructive criticism and helpful suggestions to improve the translation. \</span></span><br><span class="line"><span class="string"><span class="subst">&#123;additional_rule&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The source text and initial translation, delimited by XML tags &lt;SOURCE_TEXT&gt;&lt;/SOURCE_TEXT&gt; and &lt;TRANSLATION&gt;&lt;/TRANSLATION&gt;, are as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string">&lt;/SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;TRANSLATION&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;translation_1&#125;</span></span></span><br><span class="line"><span class="string">&lt;/TRANSLATION&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">When writing suggestions, pay attention to whether there are ways to improve the translation&#x27;s \n\</span></span><br><span class="line"><span class="string">(i) accuracy (by correcting errors of addition, mistranslation, omission, or untranslated text),\n\</span></span><br><span class="line"><span class="string">(ii) fluency (by applying <span class="subst">&#123;target_lang&#125;</span> grammar, spelling and punctuation rules, and ensuring there are no unnecessary repetitions),\n\</span></span><br><span class="line"><span class="string">(iii) style (by ensuring the translations reflect the style of the source text and takes into account any cultural context),\n\</span></span><br><span class="line"><span class="string">(iv) terminology (by ensuring terminology use is consistent and reflects the source text domain; and by only ensuring you use equivalent idioms <span class="subst">&#123;target_lang&#125;</span>).\n\</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write a list of specific, helpful and constructive suggestions for improving the translation.</span></span><br><span class="line"><span class="string">Each suggestion should address one specific part of the translation.</span></span><br><span class="line"><span class="string">Output only the suggestions and nothing else.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    reflection = get_completion(prompt, system_message=system_message)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[初次翻译结果]: \n&quot;</span>, reflection)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="string">&quot;reflection&quot;</span>: reflection &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">improve_translation</span>(<span class="params">state</span>):</span><br><span class="line">    source_lang = state.get(<span class="string">&quot;source_lang&quot;</span>)</span><br><span class="line">    target_lang = state.get(<span class="string">&quot;target_lang&quot;</span>)</span><br><span class="line">    source_text = state.get(<span class="string">&quot;source_text&quot;</span>)</span><br><span class="line">    translation_1 = state.get(<span class="string">&quot;translation_1&quot;</span>)</span><br><span class="line">    reflection = state.get(<span class="string">&quot;reflection&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    system_message = <span class="string">f&quot;You are an expert linguist, specializing in translation editing from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>.&quot;</span></span><br><span class="line"></span><br><span class="line">    prompt = <span class="string">f&quot;&quot;&quot;Your task is to carefully read, then edit, a translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>, taking into</span></span><br><span class="line"><span class="string">account a list of expert suggestions and constructive criticisms.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The source text, the initial translation, and the expert linguist suggestions are delimited by XML tags &lt;SOURCE_TEXT&gt;&lt;/SOURCE_TEXT&gt;, &lt;TRANSLATION&gt;&lt;/TRANSLATION&gt; and &lt;EXPERT_SUGGESTIONS&gt;&lt;/EXPERT_SUGGESTIONS&gt; \</span></span><br><span class="line"><span class="string">as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string">&lt;/SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;TRANSLATION&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;translation_1&#125;</span></span></span><br><span class="line"><span class="string">&lt;/TRANSLATION&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;EXPERT_SUGGESTIONS&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;reflection&#125;</span></span></span><br><span class="line"><span class="string">&lt;/EXPERT_SUGGESTIONS&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please take into account the expert suggestions when editing the translation. Edit the translation by ensuring:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(i) accuracy (by correcting errors of addition, mistranslation, omission, or untranslated text),</span></span><br><span class="line"><span class="string">(ii) fluency (by applying <span class="subst">&#123;target_lang&#125;</span> grammar, spelling and punctuation rules and ensuring there are no unnecessary repetitions), \</span></span><br><span class="line"><span class="string">(iii) style (by ensuring the translations reflect the style of the source text)</span></span><br><span class="line"><span class="string">(iv) terminology (inappropriate for context, inconsistent use), or</span></span><br><span class="line"><span class="string">(v) other errors.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Output only the new translation and nothing else.&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    translation_2 = get_completion(prompt, system_message)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[初次翻译结果]: \n&quot;</span>, translation_2)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="string">&quot;translation_2&quot;</span>: translation_2 &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 规划执行任务</span></span><br><span class="line"><span class="comment">## 节点（node）注册</span></span><br><span class="line">workflow.add_node(<span class="string">&quot;initial_translation&quot;</span>, initial_translation)</span><br><span class="line">workflow.add_node(<span class="string">&quot;reflect_on_translation&quot;</span>, reflect_on_translation)</span><br><span class="line">workflow.add_node(<span class="string">&quot;improve_translation&quot;</span>, improve_translation)</span><br><span class="line"><span class="comment">## 连接节点</span></span><br><span class="line">workflow.set_entry_point(<span class="string">&quot;initial_translation&quot;</span>)</span><br><span class="line"><span class="comment">#workflow.add_edge(START, )</span></span><br><span class="line">workflow.add_edge(<span class="string">&quot;initial_translation&quot;</span>, <span class="string">&quot;reflect_on_translation&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;reflect_on_translation&quot;</span>, <span class="string">&quot;improve_translation&quot;</span>)</span><br><span class="line">workflow.add_edge(<span class="string">&quot;improve_translation&quot;</span>, END)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开始执行</span></span><br><span class="line">app = workflow.<span class="built_in">compile</span>()</span><br><span class="line">result = app.invoke(&#123;</span><br><span class="line">    <span class="string">&quot;source_lang&quot;</span>: <span class="string">&quot;English&quot;</span>,</span><br><span class="line">    <span class="string">&quot;target_lang&quot;</span>: <span class="string">&quot;中文&quot;</span>,</span><br><span class="line">    <span class="string">&quot;source_text&quot;</span>: <span class="string">&quot;&quot;&quot;Translation Agent: Agentic translation using reflection workflow</span></span><br><span class="line"><span class="string">This is a Python demonstration of a reflection agentic workflow for machine translation. The main steps are:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Prompt an LLM to translate a text from source_language to target_language;</span></span><br><span class="line"><span class="string">Have the LLM reflect on the translation to come up with constructive suggestions for improving it;</span></span><br><span class="line"><span class="string">Use the suggestions to improve the translation.</span></span><br><span class="line"><span class="string">Customizability</span></span><br><span class="line"><span class="string">By using an LLM as the heart of the translation engine, this system is highly steerable. For example, by changing the prompts, it is easier using this workflow than a traditional machine translation (MT) system to:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Modify the output&#x27;s style, such as formal/informal.</span></span><br><span class="line"><span class="string">Specify how to handle idioms and special terms like names, technical terms, and acronyms. For example, including a glossary in the prompt lets you make sure particular terms (such as open source, H100 or GPU) are translated consistently.</span></span><br><span class="line"><span class="string">Specify specific regional use of the language, or specific dialects, to serve a target audience. For example, Spanish spoken in Latin America is different from Spanish spoken in Spain; French spoken in Canada is different from how it is spoken in France.</span></span><br><span class="line"><span class="string">This is not mature software, and is the result of Andrew playing around with translations on weekends the past few months, plus collaborators (Joaquin Dominguez, Nedelina Teneva, John Santerre) helping refactor the code.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">According to our evaluations using BLEU score on traditional translation datasets, this workflow is sometimes competitive with, but also sometimes worse than, leading commercial offerings. However, we’ve also occasionally gotten fantastic results (superior to commercial offerings) with this approach. We think this is just a starting point for agentic translations, and that this is a promising direction for translation, with significant headroom for further improvement, which is why we’re releasing this demonstration to encourage more discussion, experimentation, research and open-source contributions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If agentic translations can generate better results than traditional architectures (such as an end-to-end transformer that inputs a text and directly outputs a translation) -- which are often faster/cheaper to run than our approach here -- this also provides a mechanism to automatically generate training data (parallel text corpora) that can be used to further train and improve traditional algorithms. (See also this article in The Batch on using LLMs to generate training data.)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Comments and suggestions for how to improve this are very welcome!&quot;&quot;&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制流程图</span></span><br><span class="line"><span class="keyword">from</span> mermaid <span class="keyword">import</span> Mermaid</span><br><span class="line">Mermaid(app.get_graph().draw_mermaid())</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Agently-Workflow"><a href="#3-2-Agently-Workflow" class="headerlink" title="3.2 Agently Workflow"></a>3.2 Agently Workflow</h3><ul>
<li>Agently官网：<a target="_blank" rel="noopener" href="https://agently.cn/">Agently.cn</a></li>
<li>Agently Workflow与LangGraph的详细比较：<a target="_blank" rel="noopener" href="https://github.com/Maplemx/Agently/blob/main/playground/constrast_between_Agently_workflow_and_LangGraph.ipynb">点击查看</a></li>
<li>Agently Workflow详细教程：<a target="_blank" rel="noopener" href="https://agently.cn/guides/workflow/index.html">点击查看</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> ENV <span class="keyword">import</span> deep_seek_url, deep_seek_api_key, deep_seek_default_model</span><br><span class="line"><span class="keyword">import</span> Agently</span><br><span class="line"><span class="keyword">import</span> os </span><br><span class="line"></span><br><span class="line"><span class="comment"># 将模型请求配置设置到agent工厂，后续工厂创建的agent对象都可以继承这个配置</span></span><br><span class="line">agent_factory = (</span><br><span class="line">    Agently.AgentFactory()</span><br><span class="line">        .set_settings(<span class="string">&quot;current_model&quot;</span>, <span class="string">&quot;OAIClient&quot;</span>)</span><br><span class="line">        .set_settings(<span class="string">&quot;model.OAIClient.url&quot;</span>, deep_seek_url)</span><br><span class="line">        .set_settings(<span class="string">&quot;model.OAIClient.auth&quot;</span>, &#123; <span class="string">&quot;api_key&quot;</span>: deep_seek_api_key &#125;)</span><br><span class="line">        .set_settings(<span class="string">&quot;model.OAIClient.options&quot;</span>, &#123; <span class="string">&quot;model&quot;</span>: deep_seek_default_model &#125;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建工作流</span></span><br><span class="line">workflow = Agently.Workflow()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义关键处理节点</span></span><br><span class="line"><span class="comment">## 首次翻译</span></span><br><span class="line"><span class="meta">@workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initial_translation</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    source_lang = storage.get(<span class="string">&quot;source_lang&quot;</span>)</span><br><span class="line">    target_lang = storage.get(<span class="string">&quot;target_lang&quot;</span>)</span><br><span class="line">    source_text = storage.get(<span class="string">&quot;source_text&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个翻译agent来执行任务</span></span><br><span class="line">    translate_agent = agent_factory.create_agent()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 给翻译agent设置system信息</span></span><br><span class="line">    translate_agent.set_agent_prompt(</span><br><span class="line">        <span class="string">&quot;role&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;You are an expert linguist, specializing in translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>.&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 向翻译agent发起翻译任务请求</span></span><br><span class="line">    translation_1 = (</span><br><span class="line">        translate_agent</span><br><span class="line">        .<span class="built_in">input</span>(</span><br><span class="line"><span class="string">f&quot;&quot;&quot;This is an <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span> translation, please provide the <span class="subst">&#123;target_lang&#125;</span> translation for this text. \</span></span><br><span class="line"><span class="string">Do not provide any explanations or text apart from the translation.</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_lang&#125;</span>: <span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;target_lang&#125;</span>:&quot;&quot;&quot;</span></span><br><span class="line">        )</span><br><span class="line">        .start()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存翻译结果</span></span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;translation_1&quot;</span>, translation_1)</span><br><span class="line">    <span class="comment"># 保存翻译agent备用</span></span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;translate_agent&quot;</span>, translate_agent)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;stage&quot;</span>: <span class="string">&quot;initial translation&quot;</span>,</span><br><span class="line">        <span class="string">&quot;result&quot;</span>: translation_1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 反思优化</span></span><br><span class="line"><span class="meta">@workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reflect_on_translation</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    source_lang = storage.get(<span class="string">&quot;source_lang&quot;</span>)</span><br><span class="line">    target_lang = storage.get(<span class="string">&quot;target_lang&quot;</span>)</span><br><span class="line">    source_text = storage.get(<span class="string">&quot;source_text&quot;</span>)</span><br><span class="line">    country = storage.get(<span class="string">&quot;country&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    translation_1 = storage.get(<span class="string">&quot;translation_1&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建一个反思agent来执行任务</span></span><br><span class="line">    reflection_agent = agent_factory.create_agent()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 给反思agent设置system信息</span></span><br><span class="line">    reflection_agent.set_agent_prompt(</span><br><span class="line">        <span class="string">&quot;role&quot;</span>,</span><br><span class="line">        <span class="string">f&quot;You are an expert linguist specializing in translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>. \</span></span><br><span class="line"><span class="string">You will be provided with a source text and its translation and your goal is to improve the translation.&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    additional_rule = (</span><br><span class="line">        <span class="string">&quot;The final style and tone of the translation should match the style of &#123;target_lang&#125; colloquially spoken in &#123;country&#125;.&quot;</span></span><br><span class="line">        <span class="keyword">if</span> country != <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 向反思agent发起反思任务</span></span><br><span class="line">    reflection = (</span><br><span class="line">        reflection_agent</span><br><span class="line">            .<span class="built_in">input</span>(</span><br><span class="line"><span class="string">f&quot;&quot;&quot;Your task is to carefully read a source text and a translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>, and then give constructive criticism and helpful suggestions to improve the translation. \</span></span><br><span class="line"><span class="string"><span class="subst">&#123;additional_rule&#125;</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The source text and initial translation, delimited by XML tags &lt;SOURCE_TEXT&gt;&lt;/SOURCE_TEXT&gt; and &lt;TRANSLATION&gt;&lt;/TRANSLATION&gt;, are as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string">&lt;/SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;TRANSLATION&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;translation_1&#125;</span></span></span><br><span class="line"><span class="string">&lt;/TRANSLATION&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">When writing suggestions, pay attention to whether there are ways to improve the translation&#x27;s \n\</span></span><br><span class="line"><span class="string">(i) accuracy (by correcting errors of addition, mistranslation, omission, or untranslated text),\n\</span></span><br><span class="line"><span class="string">(ii) fluency (by applying <span class="subst">&#123;target_lang&#125;</span> grammar, spelling and punctuation rules, and ensuring there are no unnecessary repetitions),\n\</span></span><br><span class="line"><span class="string">(iii) style (by ensuring the translations reflect the style of the source text and takes into account any cultural context),\n\</span></span><br><span class="line"><span class="string">(iv) terminology (by ensuring terminology use is consistent and reflects the source text domain; and by only ensuring you use equivalent idioms <span class="subst">&#123;target_lang&#125;</span>).\n\</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Write a list of specific, helpful and constructive suggestions for improving the translation.</span></span><br><span class="line"><span class="string">Each suggestion should address one specific part of the translation.</span></span><br><span class="line"><span class="string">Output only the suggestions and nothing else.&quot;&quot;&quot;</span></span><br><span class="line">            )</span><br><span class="line">            .start()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存反思结果</span></span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;reflection&quot;</span>, reflection)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;stage&quot;</span>: <span class="string">&quot;reflection&quot;</span>,</span><br><span class="line">        <span class="string">&quot;result&quot;</span>: reflection</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 二次翻译</span></span><br><span class="line"><span class="meta">@workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">improve_translation</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    source_lang = storage.get(<span class="string">&quot;source_lang&quot;</span>)</span><br><span class="line">    target_lang = storage.get(<span class="string">&quot;target_lang&quot;</span>)</span><br><span class="line">    source_text = storage.get(<span class="string">&quot;source_text&quot;</span>)</span><br><span class="line">    translation_1 = storage.get(<span class="string">&quot;translation_1&quot;</span>)</span><br><span class="line">    reflection = storage.get(<span class="string">&quot;reflection&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 使用保存下来的翻译agent</span></span><br><span class="line">    translate_agent = storage.get(<span class="string">&quot;translate_agent&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 直接发起二次翻译任务</span></span><br><span class="line">    translation_2 = (</span><br><span class="line">        translate_agent</span><br><span class="line">            .<span class="built_in">input</span>(</span><br><span class="line"><span class="string">f&quot;&quot;&quot;Your task is to carefully read, then edit, a translation from <span class="subst">&#123;source_lang&#125;</span> to <span class="subst">&#123;target_lang&#125;</span>, taking into</span></span><br><span class="line"><span class="string">account a list of expert suggestions and constructive criticisms.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The source text, the initial translation, and the expert linguist suggestions are delimited by XML tags &lt;SOURCE_TEXT&gt;&lt;/SOURCE_TEXT&gt;, &lt;TRANSLATION&gt;&lt;/TRANSLATION&gt; and &lt;EXPERT_SUGGESTIONS&gt;&lt;/EXPERT_SUGGESTIONS&gt; \</span></span><br><span class="line"><span class="string">as follows:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;source_text&#125;</span></span></span><br><span class="line"><span class="string">&lt;/SOURCE_TEXT&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;TRANSLATION&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;translation_1&#125;</span></span></span><br><span class="line"><span class="string">&lt;/TRANSLATION&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;EXPERT_SUGGESTIONS&gt;</span></span><br><span class="line"><span class="string"><span class="subst">&#123;reflection&#125;</span></span></span><br><span class="line"><span class="string">&lt;/EXPERT_SUGGESTIONS&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Please take into account the expert suggestions when editing the translation. Edit the translation by ensuring:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(i) accuracy (by correcting errors of addition, mistranslation, omission, or untranslated text),</span></span><br><span class="line"><span class="string">(ii) fluency (by applying <span class="subst">&#123;target_lang&#125;</span> grammar, spelling and punctuation rules and ensuring there are no unnecessary repetitions), \</span></span><br><span class="line"><span class="string">(iii) style (by ensuring the translations reflect the style of the source text)</span></span><br><span class="line"><span class="string">(iv) terminology (inappropriate for context, inconsistent use), or</span></span><br><span class="line"><span class="string">(v) other errors.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Output only the new translation and nothing else.&quot;&quot;&quot;</span></span><br><span class="line">            )</span><br><span class="line">            .start()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存二次翻译结果</span></span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;translation_2&quot;</span>, translation_2)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;stage&quot;</span>: <span class="string">&quot;improve translation&quot;</span>,</span><br><span class="line">        <span class="string">&quot;result&quot;</span>: translation_2</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接工作块</span></span><br><span class="line">(</span><br><span class="line">    workflow</span><br><span class="line">        .connect_to(<span class="string">&quot;initial_translation&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;reflect_on_translation&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;improve_translation&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加过程输出优化</span></span><br><span class="line"><span class="meta">@workflow.chunk_class()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">output_stage_result</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123; inputs[<span class="string">&#x27;default&#x27;</span>][<span class="string">&#x27;stage&#x27;</span>] &#125;</span>]:\n&quot;</span>, inputs[<span class="string">&quot;default&quot;</span>][<span class="string">&quot;result&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">(</span><br><span class="line">    workflow.chunks[<span class="string">&quot;initial_translation&quot;</span>]</span><br><span class="line">        .connect_to(<span class="string">&quot;@output_stage_result&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;reflect_on_translation.wait&quot;</span>)</span><br><span class="line">)</span><br><span class="line">(</span><br><span class="line">    workflow.chunks[<span class="string">&quot;reflect_on_translation&quot;</span>]</span><br><span class="line">        .connect_to(<span class="string">&quot;@output_stage_result&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;improve_translation.wait&quot;</span>)</span><br><span class="line">)</span><br><span class="line">(</span><br><span class="line">    workflow.chunks[<span class="string">&quot;improve_translation&quot;</span>]</span><br><span class="line">        .connect_to(<span class="string">&quot;@output_stage_result&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动工作流</span></span><br><span class="line">result = workflow.start(storage = &#123;</span><br><span class="line">    <span class="string">&quot;source_lang&quot;</span>: <span class="string">&quot;English&quot;</span>,</span><br><span class="line">    <span class="string">&quot;target_lang&quot;</span>: <span class="string">&quot;中文&quot;</span>,</span><br><span class="line">    <span class="string">&quot;source_text&quot;</span>: <span class="string">&quot;&quot;&quot;Translation Agent: Agentic translation using reflection workflow</span></span><br><span class="line"><span class="string">This is a Python demonstration of a reflection agentic workflow for machine translation. The main steps are:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Prompt an LLM to translate a text from source_language to target_language;</span></span><br><span class="line"><span class="string">Have the LLM reflect on the translation to come up with constructive suggestions for improving it;</span></span><br><span class="line"><span class="string">Use the suggestions to improve the translation.</span></span><br><span class="line"><span class="string">Customizability</span></span><br><span class="line"><span class="string">By using an LLM as the heart of the translation engine, this system is highly steerable. For example, by changing the prompts, it is easier using this workflow than a traditional machine translation (MT) system to:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Modify the output&#x27;s style, such as formal/informal.</span></span><br><span class="line"><span class="string">Specify how to handle idioms and special terms like names, technical terms, and acronyms. For example, including a glossary in the prompt lets you make sure particular terms (such as open source, H100 or GPU) are translated consistently.</span></span><br><span class="line"><span class="string">Specify specific regional use of the language, or specific dialects, to serve a target audience. For example, Spanish spoken in Latin America is different from Spanish spoken in Spain; French spoken in Canada is different from how it is spoken in France.</span></span><br><span class="line"><span class="string">This is not mature software, and is the result of Andrew playing around with translations on weekends the past few months, plus collaborators (Joaquin Dominguez, Nedelina Teneva, John Santerre) helping refactor the code.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">According to our evaluations using BLEU score on traditional translation datasets, this workflow is sometimes competitive with, but also sometimes worse than, leading commercial offerings. However, we’ve also occasionally gotten fantastic results (superior to commercial offerings) with this approach. We think this is just a starting point for agentic translations, and that this is a promising direction for translation, with significant headroom for further improvement, which is why we’re releasing this demonstration to encourage more discussion, experimentation, research and open-source contributions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">If agentic translations can generate better results than traditional architectures (such as an end-to-end transformer that inputs a text and directly outputs a translation) -- which are often faster/cheaper to run than our approach here -- this also provides a mechanism to automatically generate training data (parallel text corpora) that can be used to further train and improve traditional algorithms. (See also this article in The Batch on using LLMs to generate training data.)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Comments and suggestions for how to improve this are very welcome!&quot;&quot;&quot;</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印执行结果</span></span><br><span class="line"><span class="comment">#print(workflow.storage.get(&quot;translation_1&quot;))</span></span><br><span class="line"><span class="comment">#print(workflow.storage.get(&quot;reflection&quot;))</span></span><br><span class="line"><span class="comment">#print(workflow.storage.get(&quot;translation_2&quot;))</span></span><br><span class="line"><span class="built_in">print</span>(json.dumps(result, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[initial translation]:</p>
<p> 翻译代理：使用反射工作流的代理翻译</p>
<p>这是一个展示机器翻译中反射代理工作流的Python演示。主要步骤包括：</p>
<ol>
<li>提示LLM将文本从源语言翻译到目标语言；</li>
<li>让LLM对翻译进行反思，提出改进建议；</li>
<li>利用这些建议改进翻译。</li>
</ol>
<p>可定制性</p>
<p>通过将LLM作为翻译引擎的核心，该系统具有高度可操控性。例如，通过改变提示，使用这种工作流比传统的机器翻译（MT）系统更容易：</p>
<ul>
<li>调整输出风格，如正式&#x2F;非正式。</li>
<li>指定如何处理习语和特殊术语，如名称、技术术语和缩略词。例如，在提示中包含术语表可以确保特定术语（如开源、H100或GPU）的翻译一致。</li>
<li>指定特定地区的语言使用或特定方言，以服务目标受众。例如，拉丁美洲的西班牙语与西班牙的西班牙语不同；加拿大的法语与法国的法语不同。</li>
</ul>
<p>这不是成熟的软件，是Andrew在过去几个月的周末玩转翻译的结果，加上合作者（Joaquin Dominguez、Nedelina Teneva、John Santerre）帮助重构代码。</p>
<p>根据我们使用BLEU评分在传统翻译数据集上的评估，这种工作流有时与领先的商业产品竞争，有时也表现不如它们。然而，我们也偶尔通过这种方法获得了比商业产品更出色的结果。我们认为这只是代理翻译的起点，这是一个有前途的翻译方向，有显著的改进空间，这也是我们发布这个演示以鼓励更多讨论、实验、研究和开源贡献的原因。</p>
<p>如果代理翻译能产生比传统架构（如输入文本并直接输出翻译的端到端转换器）更好的结果——这些架构通常比我们的方法更快&#x2F;更便宜——这也提供了一种自动生成训练数据（平行文本语料库）的机制，可用于进一步训练和改进传统算法。（另见《The Batch》中关于使用LLM生成训练数据的文章。）</p>
<p>非常欢迎对如何改进的意见和建议！</p>
<p>[reflection]:</p>
<ol>
<li>将“翻译代理：使用反射工作流的代理翻译”改为“代理翻译：利用反射工作流的翻译代理”，以更符合中文表达习惯。</li>
<li>将“这是一个展示机器翻译中反射代理工作流的Python演示。”改为“这是一个展示利用反射工作流进行机器翻译的Python演示。”，以提高语句的流畅性和准确性。</li>
<li>将“通过将LLM作为翻译引擎的核心，该系统具有高度可操控性。”改为“通过将LLM置于翻译引擎的核心，该系统展现出高度可操控性。”，以增强语句的流畅性。</li>
<li>将“例如，通过改变提示，使用这种工作流比传统的机器翻译（MT）系统更容易：”改为“例如，通过调整提示，使用这种工作流比传统机器翻译（MT）系统更为便捷：”，以提高语句的准确性和流畅性。</li>
<li>将“这不是成熟的软件，是Andrew在过去几个月的周末玩转翻译的结果，加上合作者（Joaquin Dominguez、Nedelina Teneva、John Santerre）帮助重构代码。”改为“这不是一款成熟的软件，而是Andrew在过去几个月的周末进行翻译实验的成果，以及合作者（Joaquin Dominguez、Nedelina Teneva、John Santerre）协助重构代码的结果。”，以提高语句的准确性和流畅性。</li>
<li>将“根据我们使用BLEU评分在传统翻译数据集上的评估，这种工作流有时与领先的商业产品竞争，有时也表现不如它们。”改为“根据我们使用BLEU评分在传统翻译数据集上的评估结果，这种工作流有时能与领先商业产品竞争，有时则表现不及它们。”，以提高语句的准确性和流畅性。</li>
<li>将“如果代理翻译能产生比传统架构（如输入文本并直接输出翻译的端到端转换器）更好的结果——这些架构通常比我们的方法更快&#x2F;更便宜——这也提供了一种自动生成训练数据（平行文本语料库）的机制，可用于进一步训练和改进传统算法。”改为“如果代理翻译能产生比传统架构（例如输入文本并直接输出翻译的端到端转换器）更优的结果——这些架构通常比我们的方法更快&#x2F;更经济——这也提供了一种自动生成训练数据（平行文本语料库）的机制，可用于进一步训练和优化传统算法。”，以提高语句的准确性和流畅性。</li>
<li>将“非常欢迎对如何改进的意见和建议！”改为“我们非常欢迎关于如何改进的意见和建议！”，以增强语句的正式性和流畅性。</li>
</ol>
<p>[improve translation]:</p>
<p> 代理翻译：利用反射工作流的翻译代理</p>
<p>这是一个展示利用反射工作流进行机器翻译的Python演示。主要步骤包括：</p>
<ol>
<li>提示LLM将文本从源语言翻译到目标语言；</li>
<li>让LLM对翻译进行反思，提出改进建议；</li>
<li>利用这些建议改进翻译。</li>
</ol>
<p>可定制性</p>
<p>通过将LLM置于翻译引擎的核心，该系统展现出高度可操控性。例如，通过调整提示，使用这种工作流比传统机器翻译（MT）系统更为便捷：</p>
<ul>
<li>调整输出风格，如正式&#x2F;非正式。</li>
<li>指定如何处理习语和特殊术语，如名称、技术术语和缩略词。例如，在提示中包含术语表可以确保特定术语（如开源、H100或GPU）的翻译一致。</li>
<li>指定特定地区的语言使用或特定方言，以服务目标受众。例如，拉丁美洲的西班牙语与西班牙的西班牙语不同；加拿大的法语与法国的法语不同。</li>
</ul>
<p>这不是一款成熟的软件，而是Andrew在过去几个月的周末进行翻译实验的成果，以及合作者（Joaquin Dominguez、Nedelina Teneva、John Santerre）协助重构代码的结果。</p>
<p>根据我们使用BLEU评分在传统翻译数据集上的评估结果，这种工作流有时能与领先商业产品竞争，有时则表现不及它们。然而，我们也偶尔通过这种方法获得了比商业产品更出色的结果。我们认为这只是代理翻译的起点，这是一个有前途的翻译方向，有显著的改进空间，这也是我们发布这个演示以鼓励更多讨论、实验、研究和开源贡献的原因。</p>
<p>如果代理翻译能产生比传统架构（例如输入文本并直接输出翻译的端到端转换器）更优的结果——这些架构通常比我们的方法更快&#x2F;更经济——这也提供了一种自动生成训练数据（平行文本语料库）的机制，可用于进一步训练和优化传统算法。（另见《The Batch》中关于使用LLM生成训练数据的文章。）</p>
<p>我们非常欢迎关于如何改进的意见和建议！</p>
<p>{</p>
<p>​    “default”: {</p>
<p>​        “stage”: “improve translation”,</p>
<p>​        “result”: “代理翻译：利用反射工作流的翻译代理\n这是一个展示利用反射工作流进行机器翻译的Python演示。主要步骤包括：\n\n1. 提示LLM将文本从源语言翻译到目标语言；\n2. 让LLM对翻译进行反思，提出改进建议；\n3. 利用这些建议改进翻译。\n\n可定制性\n通过将LLM置于翻译引擎的核心，该系统展现出高度可操控性。例如，通过调整提示，使用这种工作流比传统机器翻译（MT）系统更为便捷：\n\n- 调整输出风格，如正式&#x2F;非正式。\n- 指定如何处理习语和特殊术语，如名称、技术术语和缩略词。例如，在提示中包含术语表可以确保特定术语（如开源、H100或GPU）的翻译一致。\n- 指定特定地区的语言使用或特定方言，以服务目标受众。例如，拉丁美洲的西班牙语与西班牙的西班牙语不同；加拿大的法语与法国的法语不同。\n\n这不是一款成熟的软件，而是Andrew在过去几个月的周末进行翻译实验的成果，以及合作者（Joaquin Dominguez、Nedelina Teneva、John Santerre）协助重构代码的结果。\n\n根据我们使用BLEU评分在传统翻译数据集上的评估结果，这种工作流有时能与领先商业产品竞争，有时则表现不及它们。然而，我们也偶尔通过这种方法获得了比商业产品更出色的结果。我们认为这只是代理翻译的起点，这是一个有前途的翻译方向，有显著的改进空间，这也是我们发布这个演示以鼓励更多讨论、实验、研究和开源贡献的原因。\n\n如果代理翻译能产生比传统架构（例如输入文本并直接输出翻译的端到端转换器）更优的结果——这些架构通常比我们的方法更快&#x2F;更经济——这也提供了一种自动生成训练数据（平行文本语料库）的机制，可用于进一步训练和优化传统算法。（另见《The Batch》中关于使用LLM生成训练数据的文章。）\n\n我们非常欢迎关于如何改进的意见和建议！”</p>
<p>​    }</p>
<p>}</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">print</span>(workflow.<span class="title function_">draw</span>())</span><br></pre></td></tr></table></figure>

<blockquote>
<p>%%{ init: { ‘flowchart’: { ‘curve’: ‘linear’ }, ‘theme’: ‘neutral’ } }%%</p>
<p>%% Rendered By Agently %%</p>
<p>flowchart LR</p>
<p>classDef chunk_style fill:#fbfcdb,stroke:#666,stroke-width:1px,color:#333;</p>
<p>classDef loop_style fill:#f5f7fa,stroke:#666,stroke-width:1px,color:#333,stroke-dasharray: 5 5</p>
<p>​    f5667478-2ef6-48b3-806c-1a29df1c343f(“start”):::chunk_style -.-&gt; |”* –&gt;– default”| aa45d001-0a9b-4724-926b-b81bc04b87a3(“initial_translation”):::chunk_style</p>
<p>​    aa45d001-0a9b-4724-926b-b81bc04b87a3(“initial_translation”):::chunk_style -.-&gt; |”* –&gt;– default”| d1933f62-80c0-473e-9eaf-56b5d025a22d(“reflect_on_translation”):::chunk_style</p>
<p>​    d1933f62-80c0-473e-9eaf-56b5d025a22d(“reflect_on_translation”):::chunk_style -.-&gt; |”* –&gt;– default”| 90d4411d-505d-41d8-9519-a54e8c3ad833(“improve_translation”):::chunk_style</p>
<p>​    90d4411d-505d-41d8-9519-a54e8c3ad833(“improve_translation”):::chunk_style -.-&gt; |”* –&gt;– default”| 17a88c3b-ed5f-4ae3-b5eb-551505a3c8f3(“end”):::chunk_style</p>
<p>​    aa45d001-0a9b-4724-926b-b81bc04b87a3(“initial_translation”):::chunk_style -.-&gt; |”* –&gt;– default”| 83b817af-86e9-4c15-8bfc-a0a4cc1be58e(“@output_stage_result”):::chunk_style</p>
<p>​    83b817af-86e9-4c15-8bfc-a0a4cc1be58e(“@output_stage_result”):::chunk_style -.-&gt; |”* –&gt;– wait”| d1933f62-80c0-473e-9eaf-56b5d025a22d(“reflect_on_translation”):::chunk_style</p>
<p>​    d1933f62-80c0-473e-9eaf-56b5d025a22d(“reflect_on_translation”):::chunk_style -.-&gt; |”* –&gt;– default”| 0cd60452-a39d-4f36-8e7b-9d9c395c055f(“@output_stage_result”):::chunk_style</p>
<p>​    0cd60452-a39d-4f36-8e7b-9d9c395c055f(“@output_stage_result”):::chunk_style -.-&gt; |”* –&gt;– wait”| 90d4411d-505d-41d8-9519-a54e8c3ad833(“improve_translation”):::chunk_style</p>
<p>​    90d4411d-505d-41d8-9519-a54e8c3ad833(“improve_translation”):::chunk_style -.-&gt; |”* –&gt;– default”| 5cf69740-8561-4f89-9f7d-49eabad65388(“@output_stage_result”):::chunk_style</p>
</blockquote>
<img src="/2025/04/08/10-Workflow/1744165045394-1.png" class="">

<h2 id="4-大模型应用工作流的关键要素解析"><a href="#4-大模型应用工作流的关键要素解析" class="headerlink" title="4 大模型应用工作流的关键要素解析"></a>4 大模型应用工作流的关键要素解析</h2><h3 id="4-1-基本要素"><a href="#4-1-基本要素" class="headerlink" title="4.1 基本要素"></a>4.1 基本要素</h3><ul>
<li>工作流基本要素<ul>
<li>🟩 工作块&#x2F;工作节点</li>
<li>🔀 连接关系<ul>
<li>普通连接</li>
<li>条件连接</li>
</ul>
</li>
<li>📡 数据通讯<ul>
<li>块间数据传递</li>
<li>工作流内数据传递</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="/2025/04/08/10-Workflow/1744165045394-2.png" class="">

<h3 id="4-2-大模型应用工作流需要具备的特性"><a href="#4-2-大模型应用工作流需要具备的特性" class="headerlink" title="4.2 大模型应用工作流需要具备的特性"></a>4.2 大模型应用工作流需要具备的特性</h3><ul>
<li><strong>💫 能够成环</strong></li>
<li>以支持在特定工作环（多步工作）中反复尝试，尝试结果不符合预期可以回到第一步重试</li>
<li><strong>🛜 能够按条件分发</strong></li>
<li>以支持意图识别、路径规划、工具选择、多agent路由等场景中，根据推理结果进入不同的下游工作流，同时也能支持符合特定条件后跳出环</li>
<li><strong>⏭️ 能够多分支并行执行并在终点被等待</strong></li>
<li>以支持面对复杂任务时，能够发起不同分支从不同处理角度&#x2F;用不同处理方式对任务进行处理</li>
<li><strong>📋 能够对列表型数据进行拆分处理并回收处理结果</strong></li>
<li>例如生成行动清单、提纲等列表性质的结果后，根据列表项进行逐项处理，或执行类似Map-Reduce的逻辑</li>
<li><strong>📡 可在工作流中进行复杂通讯</strong>：<ul>
<li><strong>🛰️ 使用全局环境数据通讯</strong></li>
<li>工作流相当于提供了一个复杂的沙盒环境，沙盒环境中的全局环境数据会影响工作流运行状态，并存储工作流运行过程中的过程数据和最终成果</li>
<li><strong>📨 工作块间运行上下游通讯</strong></li>
<li>在复杂工作流中，如果所有的数据都使用全局环境数据通讯，尤其是在不同工作块中对同一个键指向的数据进行操作时，会因为对运行时序的判断困难而导致数据管理混乱，这时候，需要通过块间数据传递来确保数据变化与运行时序期望一致，用大白话说，就是确保“块2”能够正确使用它的前一个块“块1”生成的数据进行工作。</li>
</ul>
</li>
</ul>
<h3 id="4-3-LangGraph的工作流要素图示"><a href="#4-3-LangGraph的工作流要素图示" class="headerlink" title="4.3 LangGraph的工作流要素图示"></a>4.3 LangGraph的工作流要素图示</h3><img src="/2025/04/08/10-Workflow/1744165045394-3.png" class="">

<h3 id="4-4-Agently-Workflow的工作流要素图示"><a href="#4-4-Agently-Workflow的工作流要素图示" class="headerlink" title="4.4 Agently Workflow的工作流要素图示"></a>4.4 Agently Workflow的工作流要素图示</h3><img src="/2025/04/08/10-Workflow/1744165045394-4.png" class="">

<h3 id="4-5-LangGraph和Agently-Workflow的能力对比表"><a href="#4-5-LangGraph和Agently-Workflow的能力对比表" class="headerlink" title="4.5 LangGraph和Agently Workflow的能力对比表"></a>4.5 LangGraph和Agently Workflow的能力对比表</h3><p>暂时无法在飞书文档外展示此内容</p>
<p>更详细对比可<a target="_blank" rel="noopener" href="https://github.com/Maplemx/Agently/blob/main/playground/constrast_between_Agently_workflow_and_LangGraph.ipynb">访问此页面了解</a></p>
<h2 id="5-复杂的工作流：故事创作"><a href="#5-复杂的工作流：故事创作" class="headerlink" title="5 复杂的工作流：故事创作"></a>5 复杂的工作流：故事创作</h2><h3 id="5-1-设计思路"><a href="#5-1-设计思路" class="headerlink" title="5.1 设计思路"></a>5.1 设计思路</h3><img src="/2025/04/08/10-Workflow/1744165045394-5.png" class="">

<h3 id="5-2-实现方案"><a href="#5-2-实现方案" class="headerlink" title="5.2 实现方案"></a>5.2 实现方案</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> ENV <span class="keyword">import</span> deep_seek_url, deep_seek_api_key, deep_seek_default_model</span><br><span class="line"><span class="keyword">import</span> Agently</span><br><span class="line"><span class="keyword">import</span> os </span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个作家agent</span></span><br><span class="line"></span><br><span class="line">writer = (</span><br><span class="line">    Agently.create_agent()</span><br><span class="line">        .set_settings(<span class="string">&quot;current_model&quot;</span>, <span class="string">&quot;OAIClient&quot;</span>)</span><br><span class="line">        .set_settings(<span class="string">&quot;model.OAIClient.url&quot;</span>, os.environ[<span class="string">&quot;DEEPSEEK_BASE_URL&quot;</span>])</span><br><span class="line">        .set_settings(<span class="string">&quot;model.OAIClient.auth&quot;</span>, &#123; <span class="string">&quot;api_key&quot;</span>: os.environ[<span class="string">&quot;DEEPSEEK_API_KEY&quot;</span>] &#125;)</span><br><span class="line">        .set_settings(<span class="string">&quot;model.OAIClient.options&quot;</span>, &#123; <span class="string">&quot;model&quot;</span>: os.environ[<span class="string">&quot;DEEP_SEEK_DEFAULT_MODEL&quot;</span>] &#125;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建两个工作流：主工作流和分块创作工作流</span></span><br><span class="line">main_workflow = Agently.Workflow()</span><br><span class="line">block_workflow = Agently.Workflow()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义主工作流的工作块</span></span><br><span class="line"><span class="comment">## 输入一句话描述</span></span><br><span class="line"><span class="meta">@main_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_story_idea</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;story_idea&quot;</span>, <span class="built_in">input</span>(<span class="string">&quot;[💡请输入您的故事灵感]: &quot;</span>))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建世界观背景故事</span></span><br><span class="line"><span class="meta">@main_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_background</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    story_idea = storage.get(<span class="string">&quot;story_idea&quot;</span>)</span><br><span class="line">    background = (</span><br><span class="line">        writer</span><br><span class="line">            .<span class="built_in">input</span>(&#123;</span><br><span class="line">                <span class="string">&quot;故事灵感&quot;</span>: story_idea</span><br><span class="line">            &#125;)</span><br><span class="line">            .instruct(</span><br><span class="line"><span class="string">&quot;&quot;&quot;请根据&#123;故事灵感&#125;创作故事的世界信息和背景故事，其中：</span></span><br><span class="line"><span class="string">世界信息需要包括世界的主要国家或地区分布，不同国家或地区的环境描写，科技水平，信仰情况等</span></span><br><span class="line"><span class="string">世界背景故事需要以时间线的形式描述世界的主要历史沿革，国家或地区之间的重大事件及带来的影响变化等&quot;&quot;&quot;</span></span><br><span class="line">            )</span><br><span class="line">            .output(&#123;</span><br><span class="line">                <span class="string">&quot;世界名称&quot;</span>: (<span class="string">&quot;str&quot;</span>, ),</span><br><span class="line">                <span class="string">&quot;主要国家或地区&quot;</span>: [&#123;</span><br><span class="line">                    <span class="string">&quot;名称&quot;</span>: (<span class="string">&quot;str&quot;</span>, ),</span><br><span class="line">                    <span class="string">&quot;关键信息&quot;</span>: (<span class="string">&quot;str&quot;</span>, ),</span><br><span class="line">                &#125;],</span><br><span class="line">                <span class="string">&quot;世界背景故事&quot;</span>: [(<span class="string">&quot;str&quot;</span>, )],</span><br><span class="line">            &#125;)</span><br><span class="line">            .start()</span><br><span class="line">    )</span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;background&quot;</span>, background)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: <span class="string">&quot;世界观背景故事&quot;</span>,</span><br><span class="line">        <span class="string">&quot;result&quot;</span>: background,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建关键情节线</span></span><br><span class="line"><span class="meta">@main_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_storyline</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    story_idea = storage.get(<span class="string">&quot;story_idea&quot;</span>)</span><br><span class="line">    background = storage.get(<span class="string">&quot;background&quot;</span>)</span><br><span class="line">    storyline = (</span><br><span class="line">        writer</span><br><span class="line">            .<span class="built_in">input</span>(&#123;</span><br><span class="line">                <span class="string">&quot;故事灵感&quot;</span>: story_idea,</span><br><span class="line">                <span class="string">&quot;世界观背景故事&quot;</span>: background,</span><br><span class="line">            &#125;)</span><br><span class="line">            .instruct(</span><br><span class="line"><span class="string">&quot;&quot;&quot;请根据&#123;世界观背景故事&#125;，围绕&#123;故事灵感&#125;，创作故事的关键情节线安排&quot;&quot;&quot;</span></span><br><span class="line">            )</span><br><span class="line">            .output(&#123;</span><br><span class="line">                <span class="string">&quot;情节结构类型&quot;</span>: (<span class="string">&quot;str&quot;</span>, <span class="string">&quot;基于常见的故事、小说、剧作创作方法，输出你将要使用的剧情结构类型名称&quot;</span>),</span><br><span class="line">                <span class="string">&quot;情节结构特点&quot;</span>: (<span class="string">&quot;str&quot;</span>, <span class="string">&quot;阐述&#123;剧情结构类型&#125;的剧情结构手法、特点&quot;</span>),</span><br><span class="line">                <span class="string">&quot;故事线详细创作&quot;</span>: [&#123;</span><br><span class="line">                    <span class="string">&quot;本段故事作用&quot;</span>: (<span class="string">&quot;str&quot;</span>, <span class="string">&quot;描述本段故事在整体结构中发挥的作用&quot;</span>),</span><br><span class="line">                    <span class="string">&quot;关键情节&quot;</span>: ([(<span class="string">&quot;str&quot;</span>, )], <span class="string">&quot;按时序描述本段故事中的关键情节，以及情节中的关键细节&quot;</span>),</span><br><span class="line">                    <span class="string">&quot;涉及关键人物&quot;</span>: ([(<span class="string">&quot;str&quot;</span>, )], <span class="string">&quot;给出本段故事中涉及的关键人物名&quot;</span>),</span><br><span class="line">                &#125;],</span><br><span class="line">            &#125;)</span><br><span class="line">            .start()</span><br><span class="line">    )</span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;storyline&quot;</span>, storyline)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: <span class="string">&quot;关键情节线&quot;</span>,</span><br><span class="line">        <span class="string">&quot;result&quot;</span>: storyline,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 分发故事段落设计</span></span><br><span class="line"><span class="meta">@main_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_story_block_list</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    storyline = storage.get(<span class="string">&quot;storyline&quot;</span>)</span><br><span class="line">    storyline_details = storyline[<span class="string">&quot;故事线详细创作&quot;</span>]</span><br><span class="line">    extra_instruction = <span class="built_in">input</span>(<span class="string">&quot;[您是否还有其他创作指导说明？如创作风格、注意事项等]&quot;</span>)</span><br><span class="line">    story_block_list = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> storyline_details:</span><br><span class="line">        item.update(&#123; <span class="string">&quot;补充创作指导&quot;</span>: extra_instruction &#125;)</span><br><span class="line">        story_block_list.append(item)</span><br><span class="line">    <span class="keyword">return</span> story_block_list</span><br><span class="line"></span><br><span class="line"><span class="comment">## 过程产出输出</span></span><br><span class="line"><span class="meta">@main_workflow.chunk_class()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_process_output</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123; inputs[<span class="string">&#x27;default&#x27;</span>][<span class="string">&#x27;title&#x27;</span>] &#125;</span>]:&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(inputs[<span class="string">&quot;default&quot;</span>][<span class="string">&quot;result&quot;</span>], <span class="built_in">dict</span>):</span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            json.dumps(inputs[<span class="string">&quot;default&quot;</span>][<span class="string">&quot;result&quot;</span>], indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(inputs[<span class="string">&quot;default&quot;</span>][<span class="string">&quot;result&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 最终结果整理</span></span><br><span class="line"><span class="meta">@main_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sort_out</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> inputs[<span class="string">&quot;default&quot;</span>]:</span><br><span class="line">        result.append(item[<span class="string">&quot;default&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\n\n&quot;</span>.join(result)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义分块创作工作流的工作块</span></span><br><span class="line"><span class="comment">## 获取初始数据</span></span><br><span class="line"><span class="meta">@block_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">init_data</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;story_block&quot;</span>, inputs[<span class="string">&quot;default&quot;</span>])</span><br><span class="line">    <span class="comment"># 从公共存储中取出上一段创作结果</span></span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;last_block_content&quot;</span>, block_workflow.public_storage.get(<span class="string">&quot;last_block_content&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 进行正文创作</span></span><br><span class="line"><span class="meta">@block_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_block_content</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    <span class="comment"># 要考虑的条件较多，可以在请求外部构造input和instruct的prompt数据</span></span><br><span class="line">    <span class="comment">## 围绕故事线详细创作信息的prompt</span></span><br><span class="line">    <span class="comment">## &#123;&quot;本段故事作用&quot;: ,&quot;关键情节&quot;: , &quot;涉及关键人物&quot;: , &quot;补充创作指导&quot;: &#125;</span></span><br><span class="line">    input_dict = storage.get(<span class="string">&quot;story_block&quot;</span>)</span><br><span class="line">    instruction_list = [</span><br><span class="line">        <span class="string">&quot;参考&#123;本段故事作用&#125;及&#123;涉及关键人物&#125;，将&#123;关键情节&#125;扩写为完整的故事&quot;</span>,</span><br><span class="line">        <span class="string">&quot;每段故事需要尽量包括行动描写、心理活动描写和对白等细节&quot;</span>,</span><br><span class="line">        <span class="string">&quot;每次创作只是完整文章结构中的一部分，承担&#123;本段故事作用&#125;说明的作用任务，只需要按要求完成&#123;关键情节&#125;的描述即可，不需要考虑本段故事自身结构的完整性&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">## 如果有前一段内容，通过传入前一段内容末尾确保创作的连贯性</span></span><br><span class="line">    last_block_content = storage.get(<span class="string">&quot;last_block_content&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> last_block_content:</span><br><span class="line">        <span class="comment">## 在这里取上一段落的最后50个字，可根据需要修改保留的长度</span></span><br><span class="line">        keep_length = <span class="number">50</span></span><br><span class="line">        input_dict.update(&#123; <span class="string">&quot;上一段落的末尾&quot;</span>: last_block_content[(-<span class="number">1</span> * keep_length):] &#125;)</span><br><span class="line">        instruction_list.append(<span class="string">&quot;创作时需要承接&#123;上一段落的末尾&#125;，确保表达的连贯性&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">## 如果有人类评判反馈的修改意见，添加prompt</span></span><br><span class="line">    last_generation = storage.get(<span class="string">&quot;block_content&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    revision_suggestion = storage.get(<span class="string">&quot;revision_suggestion&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> last_generation <span class="keyword">and</span> revision_suggestion:</span><br><span class="line">        input_dict.update(&#123;</span><br><span class="line">            <span class="string">&quot;已有创作结果&quot;</span>: last_generation,</span><br><span class="line">            <span class="string">&quot;修改意见&quot;</span>: revision_suggestion,</span><br><span class="line">        &#125;)</span><br><span class="line">        instruction_list.append(<span class="string">&quot;你之前已经创作了&#123;已有创作结果&#125;，但仍然需要修改，请参考&#123;修改意见&#125;进行修订&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 开始创作</span></span><br><span class="line">    block_content = (</span><br><span class="line">        writer</span><br><span class="line">            .<span class="built_in">input</span>(input_dict)</span><br><span class="line">            .instruct(instruction_list)</span><br><span class="line">            .start()</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存创作结果</span></span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;block_content&quot;</span>, block_content)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;title&quot;</span>: <span class="string">f&quot;本轮创作目标：<span class="subst">&#123; input_dict[<span class="string">&#x27;本段故事作用&#x27;</span>] &#125;</span>&quot;</span>,</span><br><span class="line">        <span class="string">&quot;result&quot;</span>: block_content,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 人类判断是否满意</span></span><br><span class="line"><span class="meta">@block_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">human_confirm</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    confirm = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> confirm.lower() <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">&quot;y&quot;</span>, <span class="string">&quot;n&quot;</span>):</span><br><span class="line">        confirm = <span class="built_in">input</span>(<span class="string">&quot;[您是否满意本次创作结果？(y/n)]: &quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> confirm.lower()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 提交修改意见</span></span><br><span class="line"><span class="meta">@block_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">input_revision_suggestion</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    storage.<span class="built_in">set</span>(<span class="string">&quot;revision_suggestion&quot;</span>, <span class="built_in">input</span>(<span class="string">&quot;[请输入您的修改意见]: &quot;</span>))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 输出满意的创作成果</span></span><br><span class="line"><span class="meta">@block_workflow.chunk()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">return_block_content</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    block_content = storage.get(<span class="string">&quot;block_content&quot;</span>)</span><br><span class="line">    <span class="comment"># 记得在公共存储中更新本次创作结果</span></span><br><span class="line">    block_workflow.public_storage.<span class="built_in">set</span>(<span class="string">&quot;last_block_content&quot;</span>, block_content)</span><br><span class="line">    <span class="keyword">return</span> block_content</span><br><span class="line"></span><br><span class="line"><span class="comment">## 过程产出输出</span></span><br><span class="line"><span class="meta">@block_workflow.chunk_class()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_process_output</span>(<span class="params">inputs, storage</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[<span class="subst">&#123; inputs[<span class="string">&#x27;default&#x27;</span>][<span class="string">&#x27;title&#x27;</span>] &#125;</span>]:&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(inputs[<span class="string">&quot;default&quot;</span>][<span class="string">&quot;result&quot;</span>], <span class="built_in">dict</span>):</span><br><span class="line">        <span class="built_in">print</span>(</span><br><span class="line">            json.dumps(inputs[<span class="string">&quot;default&quot;</span>][<span class="string">&quot;result&quot;</span>], indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(inputs[<span class="string">&quot;default&quot;</span>][<span class="string">&quot;result&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义分块创作工作流的工作流程</span></span><br><span class="line">(</span><br><span class="line">    block_workflow</span><br><span class="line">        .connect_to(<span class="string">&quot;init_data&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;generate_block_content&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;@print_process_output&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;human_confirm&quot;</span>)</span><br><span class="line">        .if_condition(<span class="keyword">lambda</span> return_value, storage: return_value == <span class="string">&quot;y&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;return_block_content&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">        .else_condition()</span><br><span class="line">            .connect_to(<span class="string">&quot;input_revision_suggestion&quot;</span>)</span><br><span class="line">            .connect_to(<span class="string">&quot;generate_block_content&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">(</span><br><span class="line">    main_workflow</span><br><span class="line">        .connect_to(<span class="string">&quot;input_story_idea&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;generate_background&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;@print_process_output&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;generate_storyline&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;@print_process_output&quot;</span>)</span><br><span class="line">        .connect_to(<span class="string">&quot;send_story_block_list&quot;</span>)<span class="comment"># -&gt; list[item1, item2, item3, ...]</span></span><br><span class="line">            .loop_with(block_workflow) <span class="comment"># item1 -&gt; block_workflow:inputs[&quot;default&quot;]; item2 -&gt; block_workflow: i</span></span><br><span class="line">        <span class="comment">#.connect_to(&quot;sort_out&quot;)</span></span><br><span class="line">        .connect_to(<span class="string">&quot;end&quot;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印流程图，检查流程正确性</span></span><br><span class="line"><span class="built_in">print</span>(main_workflow.draw())</span><br></pre></td></tr></table></figure>

<blockquote>
<p>%%{ init: { ‘flowchart’: { ‘curve’: ‘linear’ }, ‘theme’: ‘neutral’ } }%%</p>
<p>%% Rendered By Agently %%</p>
<p>flowchart LR</p>
<p>classDef chunk_style fill:#fbfcdb,stroke:#666,stroke-width:1px,color:#333;</p>
<p>classDef loop_style fill:#f5f7fa,stroke:#666,stroke-width:1px,color:#333,stroke-dasharray: 5 5</p>
<p>​    subgraph Loop_1</p>
<p>​    direction LR</p>
<p>​    c6449090-6e6c-46e6-9745-cf7db9373c85(“start”):::chunk_style -.-&gt; |”* –&gt;– default”| 3f42d002-28bb-49bd-b3d9-5c5445175f78(“init_data”):::chunk_style</p>
<p>​    3f42d002-28bb-49bd-b3d9-5c5445175f78(“init_data”):::chunk_style -.-&gt; |”* –&gt;– default”| 75540bad-febf-4851-9206-62eead524826(“generate_block_content”):::chunk_style</p>
<p>​    75540bad-febf-4851-9206-62eead524826(“generate_block_content”):::chunk_style -.-&gt; |”* –&gt;– default”| c1b724dc-556e-4782-accb-56ed4ed7f9e6(“@print_process_output”):::chunk_style</p>
<p>​    c1b724dc-556e-4782-accb-56ed4ed7f9e6(“@print_process_output”):::chunk_style -.-&gt; |”* –&gt;– default”| c3e718df-ad17-4634-b1ff-de46ec55beba(“human_confirm”):::chunk_style</p>
<p>​    c3e718df-ad17-4634-b1ff-de46ec55beba(“human_confirm”):::chunk_style -.-&gt; |”* – ◇ – default”| 02b7ce51-51fa-48a7-a758-b35dc01061d7(“return_block_content”):::chunk_style</p>
<p>​    02b7ce51-51fa-48a7-a758-b35dc01061d7(“return_block_content”):::chunk_style -.-&gt; |”* –&gt;– default”| 536cb2c9-8f64-4f38-b93f-7ca4acad4afe(“end”):::chunk_style</p>
<p>​    c3e718df-ad17-4634-b1ff-de46ec55beba(“human_confirm”):::chunk_style -.-&gt; |”* – ◇ – default”| f480189c-0b7d-4715-8b09-0398590581f4(“input_revision_suggestion”):::chunk_style</p>
<p>​    f480189c-0b7d-4715-8b09-0398590581f4(“input_revision_suggestion”):::chunk_style -.-&gt; |”* –&gt;– default”| 75540bad-febf-4851-9206-62eead524826(“generate_block_content”):::chunk_style</p>
<p>​    end</p>
<p>​    45622db2-1a8d-4af9-8312-c909f06c7de4(“start”):::chunk_style -.-&gt; |”* –&gt;– default”| 3861bd24-79b4-4982-ba2a-23d5dc615ae7(“input_story_idea”):::chunk_style</p>
<p>​    3861bd24-79b4-4982-ba2a-23d5dc615ae7(“input_story_idea”):::chunk_style -.-&gt; |”* –&gt;– default”| af6687bf-aaf3-49f7-9b9e-a0448f7585e8(“generate_background”):::chunk_style</p>
<p>​    af6687bf-aaf3-49f7-9b9e-a0448f7585e8(“generate_background”):::chunk_style -.-&gt; |”* –&gt;– default”| 7edb6345-4177-4087-b826-8271c56b5bcd(“@print_process_output”):::chunk_style</p>
<p>​    7edb6345-4177-4087-b826-8271c56b5bcd(“@print_process_output”):::chunk_style -.-&gt; |”* –&gt;– default”| b72ac1a4-2c76-43dc-b7fb-231e65dc87d8(“generate_storyline”):::chunk_style</p>
<p>​    b72ac1a4-2c76-43dc-b7fb-231e65dc87d8(“generate_storyline”):::chunk_style -.-&gt; |”* –&gt;– default”| a7235cad-acf8-42e7-be0e-a3ec5fdb0c53(“@print_process_output”):::chunk_style</p>
<p>​    a7235cad-acf8-42e7-be0e-a3ec5fdb0c53(“@print_process_output”):::chunk_style -.-&gt; |”* –&gt;– default”| dc4b4f9a-ea0d-4a56-8c84-6d0a008eedb3(“send_story_block_list”):::chunk_style</p>
<p>​    dc4b4f9a-ea0d-4a56-8c84-6d0a008eedb3(“send_story_block_list”):::chunk_style -.-&gt; |”* –&gt;– default”| Loop_1:::loop_style</p>
<p>​    Loop_1:::loop_style -.-&gt; |”* –&gt;– default”| 9402a2c0-94ca-407a-87da-d69798c342a6(“sort_out”):::chunk_style</p>
<p>​    9402a2c0-94ca-407a-87da-d69798c342a6(“sort_out”):::chunk_style -.-&gt; |”* –&gt;– default”| 3690195b-905e-4938-b70a-7184725a4066(“end”):::chunk_style</p>
</blockquote>
<img src="/2025/04/08/10-Workflow/1744165045394-6.jpeg" class="">

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 开始执行</span><br><span class="line">result = main_workflow.<span class="title function_">start</span>()</span><br><span class="line"><span class="title function_">print</span>(result[<span class="string">&quot;default&quot;</span>])</span><br></pre></td></tr></table></figure>

<blockquote>
<p>[世界观背景故事]:</p>
<p>{</p>
<p>​    “世界名称”: “星际争霸宇宙”,</p>
<p>​    “主要国家或地区”: [</p>
<p>​        {</p>
<p>​            “名称”: “泰伦联邦”,</p>
<p>​            “关键信息”: “位于克普鲁星区，环境多样，从沙漠到冰原，科技水平高，信仰多样，以人类至上主义为主。”</p>
<p>​        },</p>
<p>​        {</p>
<p>​            “名称”: “凯尔-莫拉联合体”,</p>
<p>​            “关键信息”: “由多个外星种族组成，环境以森林和山脉为主，科技水平与泰伦联邦相当，信仰以自然和谐为核心。”</p>
<p>​        },</p>
<p>​        {</p>
<p>​            “名称”: “异虫巢群”,</p>
<p>​            “关键信息”: “遍布多个星系，环境适应性强，科技以生物进化为主，无明确信仰，以生存和扩张为唯一目标。”</p>
<p>​        }</p>
<p>​    ],</p>
<p>​    “世界背景故事”: [</p>
<p>​        “2480年，泰伦联邦在克普鲁星区建立殖民地，开始了人类的新篇章。”,</p>
<p>​        “2490年，凯尔-莫拉联合体与泰伦联邦建立外交关系，促进了星际间的科技和文化交流。”,</p>
<p>​        “2500年，异虫巢群首次出现在克普鲁星区，引发了人类和联合体的联合抵抗。”,</p>
<p>​        “2510年，泰伦联邦内部发生分裂，形成了多个派系，加剧了星区的政治动荡。”,</p>
<p>​        “2520年，人类小兵在多次与异虫的战斗中成长，逐渐成为抵抗异虫的中坚力量。”,</p>
<p>​        “2530年，泰伦联邦与凯尔-莫拉联合体共同研发新型武器，有效遏制了异虫的扩张。”,</p>
<p>​        “2540年，星际间的和平协议签署，但各方仍保持警惕，以防异虫的再次入侵。”</p>
<p>​    ]</p>
<p>}</p>
<p>[关键情节线]:</p>
<p>{</p>
<p>​    “情节结构类型”: “三幕结构”,</p>
<p>​    “情节结构特点”: “三幕结构是戏剧和电影中常见的故事结构，包括第一幕的设定和引入，第二幕的冲突和对抗，以及第三幕的高潮和解决。这种结构有助于清晰地展现故事的发展和角色的成长。”,</p>
<p>​    “故事线详细创作”: [</p>
<p>​        {</p>
<p>​            “本段故事作用”: “引入和设定”,</p>
<p>​            “关键情节”: [</p>
<p>​                “主角在泰伦联邦的军事训练中表现平平，但因一次偶然事件展现出潜力”,</p>
<p>​                “主角被分配到前线部队，首次接触异虫巢群”,</p>
<p>​                “主角在第一次战斗中表现出色，获得上级关注”</p>
<p>​            ],</p>
<p>​            “涉及关键人物”: [</p>
<p>​                “主角”,</p>
<p>​                “上级指挥官”</p>
<p>​            ]</p>
<p>​        },</p>
<p>​        {</p>
<p>​            “本段故事作用”: “冲突和对抗”,</p>
<p>​            “关键情节”: [</p>
<p>​                “主角在多次与异虫的战斗中逐渐成长，成为小队核心”,</p>
<p>​                “泰伦联邦内部政治动荡，主角面临忠诚与个人信念的抉择”,</p>
<p>​                “主角与凯尔-莫拉联合体的战士合作，共同对抗异虫”,</p>
<p>​                “主角在一次关键战役中失去战友，决心更加坚定”</p>
<p>​            ],</p>
<p>​            “涉及关键人物”: [</p>
<p>​                “主角”,</p>
<p>​                “战友”,</p>
<p>​                “凯尔-莫拉联合体战士”</p>
<p>​            ]</p>
<p>​        },</p>
<p>​        {</p>
<p>​            “本段故事作用”: “高潮和解决”,</p>
<p>​            “关键情节”: [</p>
<p>​                “主角参与研发新型武器，对抗异虫的扩张”,</p>
<p>​                “主角在最终战役中发挥关键作用，成功遏制异虫”,</p>
<p>​                “星际间的和平协议签署，主角成为英雄”,</p>
<p>​                “主角反思战争经历，决定继续为和平而战”</p>
<p>​            ],</p>
<p>​            “涉及关键人物”: [</p>
<p>​                “主角”,</p>
<p>​                “泰伦联邦高层”,</p>
<p>​                “凯尔-莫拉联合体领袖”</p>
<p>​            ]</p>
<p>​        }</p>
<p>​    ]</p>
<p>}</p>
<p>[您是否还有其他创作指导说明？如创作风格、注意事项等] 主角的名字设定成麦克，战友的名字设定成杰芬，我比较喜欢Lovecraft的克苏鲁系神话风格，可以在创作的时候尝试加入这类风格</p>
<p>[本轮创作目标：引入和设定]:</p>
<p>在泰伦联邦的军事训练营中，麦克的名字并不响亮。他的表现平平，如同大多数新兵一样，默默无闻。然而，命运的齿轮在某个不经意的瞬间开始转动。一次偶然的模拟战斗中，麦克面对虚拟的异虫巢群，他的反应速度和战术判断远超预期，仿佛他的血液中流淌着古老的战斗智慧。这一幕被上级指挥官敏锐地捕捉到，他的眼中闪过一丝期待。</p>
<p>“麦克，你的表现很有潜力。” 上级指挥官的声音在训练结束后响起，他的目光如鹰隼般锐利，“你将被分配到前线部队，那里才是真正考验你的地方。”</p>
<p>麦克的心中涌起一股复杂的情绪，既有对未知的恐惧，也有对挑战的渴望。他知道，前线的战场不同于训练场，那里的异虫巢群是真实而残酷的。</p>
<p>不久，麦克和他的战友杰芬一起被派往前线。当他们首次接触到真实的异虫巢群时，那种压迫感和恐怖感如同克苏鲁神话中的深海巨兽，无声地吞噬着新兵们的勇气。然而，麦克的心中却涌现出一种奇异的平静，仿佛他早已预见了这一刻。</p>
<p>在第一次战斗中，麦克的指挥冷静而果断，他利用地形和战术，成功地引导战友们击退了异虫的进攻。他的表现不仅赢得了战友们的尊敬，也引起了上级指挥官的进一步关注。</p>
<p>“麦克，你的战术运用得很好。” 上级指挥官在战后的简报中赞许道，“继续保持，你的潜力远不止于此。”</p>
<p>麦克点了点头，他的心中充满了对未来的期待和对未知的敬畏。他知道，这场战争只是开始，而他，麦克，将在这场与异虫的较量中，逐渐揭开自己命运的神秘面纱。</p>
<p>[请输入您的修改意见]:  1. 上级指挥官加一个名字，叫凯恩；2. 风格使用克苏鲁神话风格，但在文中不要出现“克苏鲁”这样的字样；3. 第一次战斗的过程描述不够清晰，添加更多的战斗细节，展现战斗的残酷</p>
<p>[本轮创作目标：引入和设定]:</p>
<p>在泰伦联邦的军事训练营中，麦克的名字并不响亮。他的表现平平，如同大多数新兵一样，默默无闻。然而，命运的齿轮在某个不经意的瞬间开始转动。一次偶然的模拟战斗中，麦克面对虚拟的异虫巢群，他的反应速度和战术判断远超预期，仿佛他的血液中流淌着古老的战斗智慧。这一幕被上级指挥官凯恩敏锐地捕捉到，他的眼中闪过一丝期待。</p>
<p>“麦克，你的表现很有潜力。” 凯恩的声音在训练结束后响起，他的目光如鹰隼般锐利，“你将被分配到前线部队，那里才是真正考验你的地方。”</p>
<p>麦克的心中涌起一股复杂的情绪，既有对未知的恐惧，也有对挑战的渴望。他知道，前线的战场不同于训练场，那里的异虫巢群是真实而残酷的。</p>
<p>不久，麦克和他的战友杰芬一起被派往前线。当他们首次接触到真实的异虫巢群时，那种压迫感和恐怖感如同深海中的不可名状之物，无声地吞噬着新兵们的勇气。然而，麦克的心中却涌现出一种奇异的平静，仿佛他早已预见了这一刻。</p>
<p>在第一次战斗中，麦克的指挥冷静而果断。他利用地形和战术，巧妙地引导战友们避开异虫的正面冲击，转而攻击它们的侧翼。战斗异常激烈，异虫的嘶吼声和枪炮的轰鸣交织在一起，空气中弥漫着硝烟和血腥味。麦克的耳边回响着凯恩的教诲，他的每一个决策都显得异常关键。在一次关键的反击中，麦克亲自带领一小队士兵，利用烟雾弹掩护，成功地突破了异虫的防线，击溃了它们的指挥中枢。</p>
<p>“麦克，你的战术运用得很好。” 凯恩在战后的简报中赞许道，“继续保持，你的潜力远不止于此。”</p>
<p>麦克点了点头，他的心中充满了对未来的期待和对未知的敬畏。他知道，这场战争只是开始，而他，麦克，将在这场与异虫的较量中，逐渐揭开自己命运的神秘面纱。</p>
<p>[本轮创作目标：冲突和对抗]:</p>
<p>麦克站在战场的废墟中，四周是异虫残破的尸体和燃烧的残骸。他的战甲上沾满了血迹和污泥，但他的眼神却异常坚定。经过多次与异虫的战斗，麦克已经从小队中的一名普通士兵成长为核心成员。他的战术眼光和战斗技巧在每一次交锋中都得到了提升，队友们对他的信任也日益加深。</p>
<p>“麦克，你还好吗？”杰芬的声音从通讯器中传来，他的语气中带着关切。</p>
<p>“我还好，杰芬。只是…这场战斗比我们预想的要艰难。”麦克回应道，他的目光扫过战场，寻找着任何可能的威胁。</p>
<p>泰伦联邦内部的动荡让麦克感到不安。政治斗争的阴影笼罩在每个人的心头，而麦克必须在忠诚于联邦和坚持自己的信念之间做出选择。这种内心的挣扎让他夜不能寐，但他知道，无论选择哪条路，他都必须坚定地走下去。</p>
<p>在一次与凯尔-莫拉联合体的联合行动中，麦克与他们的战士并肩作战。这些战士的战斗风格与泰伦联邦的士兵截然不同，但他们对异虫的仇恨却是相同的。在一次短暂的休息中，麦克与一名凯尔-莫拉的战士坐在一起。</p>
<p>“你们为什么要与我们合作？”麦克问道，他的声音中带着好奇。</p>
<p>“因为我们有共同的敌人，麦克。异虫是我们所有人的威胁。”那名战士回答，他的眼神坚定而冷酷。</p>
<p>在一次关键战役中，麦克失去了杰芬。当他在战场上找到杰芬的遗体时，他的心中充满了痛苦和愤怒。他紧紧握住杰芬的手，低声说道：“我会为你报仇的，杰芬。我会让这些异虫付出代价。”</p>
<p>从那一刻起，麦克的决心更加坚定。他知道，这场战争远未结束，而他，麦克，将继续在这场与异虫的较量中，揭开自己命运的神秘面纱。他的心中充满了对未知的敬畏，但他也明白，只有通过不断的战斗和牺牲，他才能找到真正的答案。</p>
<p>[本轮创作目标：高潮和解决]:</p>
<p>麦克站在泰伦联邦的研发中心，眼前是一排排闪烁着蓝光的仪器和忙碌的科学家们。他的心中充满了对未知的敬畏，但他也明白，只有通过不断的战斗和牺牲，他才能找到真正的答案。新型武器的研发已经进入最后阶段，这是对抗异虫扩张的关键。</p>
<p>“麦克，你准备好了吗？”杰芬走过来，拍了拍他的肩膀。</p>
<p>“当然，杰芬。我们不能让这些异虫继续扩张下去。”麦克坚定地回答。</p>
<p>在接下来的几周里，麦克和杰芬与科学家们一起，日以继夜地工作，终于完成了新型武器的研发。这种武器能够有效地抑制异虫的繁殖和扩张，是泰伦联邦对抗异虫的最后希望。</p>
<p>最终战役的前夜，麦克站在指挥舰的甲板上，望着星空。他的心中充满了紧张和期待。他知道，明天的战斗将决定星际间的未来。</p>
<p>“麦克，你看起来很紧张。”泰伦联邦的高层走过来，关切地问道。</p>
<p>“是的，长官。这是我第一次面对如此大规模的战斗。”麦克坦诚地回答。</p>
<p>“记住，麦克，你不是一个人在战斗。我们都在你身边。”高层鼓励道。</p>
<p>第二天，战斗开始了。麦克和杰芬带领着他们的部队，冲向异虫的巢穴。新型武器发挥了巨大的作用，异虫的扩张被成功遏制。经过几个小时的激战，泰伦联邦取得了胜利。</p>
<p>战斗结束后，麦克站在战场上，望着满目疮痍的景象，心中充满了复杂的情感。他知道，这场胜利只是暂时的，真正的和平还需要更多的努力。</p>
<p>在星际间的和平协议签署仪式上，麦克被授予英雄的称号。他站在台上，望着台下的众人，心中充满了感慨。</p>
<p>“麦克，你成为了我们的英雄。”凯尔-莫拉联合体的领袖走上前来，微笑着说道。</p>
<p>“谢谢，但我只是做了我应该做的事情。”麦克谦虚地回答。</p>
<p>仪式结束后，麦克独自一人走在星际港口的甲板上，望着远处的星空。他反思着自己的战争经历，决定继续为和平而战。他知道，真正的答案还在前方，而他将继续追寻。</p>
<p>在泰伦联邦的军事训练营中，麦克的名字并不响亮。他的表现平平，如同大多数新兵一样，默默无闻。然而，命运的齿轮在某个不经意的瞬间开始转动。一次偶然的模拟战斗中，麦克面对虚拟的异虫巢群，他的反应速度和战术判断远超预期，仿佛他的血液中流淌着古老的战斗智慧。这一幕被上级指挥官凯恩敏锐地捕捉到，他的眼中闪过一丝期待。</p>
<p>“麦克，你的表现很有潜力。” 凯恩的声音在训练结束后响起，他的目光如鹰隼般锐利，“你将被分配到前线部队，那里才是真正考验你的地方。”</p>
<p>麦克的心中涌起一股复杂的情绪，既有对未知的恐惧，也有对挑战的渴望。他知道，前线的战场不同于训练场，那里的异虫巢群是真实而残酷的。</p>
<p>不久，麦克和他的战友杰芬一起被派往前线。当他们首次接触到真实的异虫巢群时，那种压迫感和恐怖感如同深海中的不可名状之物，无声地吞噬着新兵们的勇气。然而，麦克的心中却涌现出一种奇异的平静，仿佛他早已预见了这一刻。</p>
<p>在第一次战斗中，麦克的指挥冷静而果断。他利用地形和战术，巧妙地引导战友们避开异虫的正面冲击，转而攻击它们的侧翼。战斗异常激烈，异虫的嘶吼声和枪炮的轰鸣交织在一起，空气中弥漫着硝烟和血腥味。麦克的耳边回响着凯恩的教诲，他的每一个决策都显得异常关键。在一次关键的反击中，麦克亲自带领一小队士兵，利用烟雾弹掩护，成功地突破了异虫的防线，击溃了它们的指挥中枢。</p>
<p>“麦克，你的战术运用得很好。” 凯恩在战后的简报中赞许道，“继续保持，你的潜力远不止于此。”</p>
<p>麦克点了点头，他的心中充满了对未来的期待和对未知的敬畏。他知道，这场战争只是开始，而他，麦克，将在这场与异虫的较量中，逐渐揭开自己命运的神秘面纱。</p>
<p>麦克站在战场的废墟中，四周是异虫残破的尸体和燃烧的残骸。他的战甲上沾满了血迹和污泥，但他的眼神却异常坚定。经过多次与异虫的战斗，麦克已经从小队中的一名普通士兵成长为核心成员。他的战术眼光和战斗技巧在每一次交锋中都得到了提升，队友们对他的信任也日益加深。</p>
<p>“麦克，你还好吗？”杰芬的声音从通讯器中传来，他的语气中带着关切。</p>
<p>“我还好，杰芬。只是…这场战斗比我们预想的要艰难。”麦克回应道，他的目光扫过战场，寻找着任何可能的威胁。</p>
<p>泰伦联邦内部的动荡让麦克感到不安。政治斗争的阴影笼罩在每个人的心头，而麦克必须在忠诚于联邦和坚持自己的信念之间做出选择。这种内心的挣扎让他夜不能寐，但他知道，无论选择哪条路，他都必须坚定地走下去。</p>
<p>在一次与凯尔-莫拉联合体的联合行动中，麦克与他们的战士并肩作战。这些战士的战斗风格与泰伦联邦的士兵截然不同，但他们对异虫的仇恨却是相同的。在一次短暂的休息中，麦克与一名凯尔-莫拉的战士坐在一起。</p>
<p>“你们为什么要与我们合作？”麦克问道，他的声音中带着好奇。</p>
<p>“因为我们有共同的敌人，麦克。异虫是我们所有人的威胁。”那名战士回答，他的眼神坚定而冷酷。</p>
<p>在一次关键战役中，麦克失去了杰芬。当他在战场上找到杰芬的遗体时，他的心中充满了痛苦和愤怒。他紧紧握住杰芬的手，低声说道：“我会为你报仇的，杰芬。我会让这些异虫付出代价。”</p>
<p>从那一刻起，麦克的决心更加坚定。他知道，这场战争远未结束，而他，麦克，将继续在这场与异虫的较量中，揭开自己命运的神秘面纱。他的心中充满了对未知的敬畏，但他也明白，只有通过不断的战斗和牺牲，他才能找到真正的答案。</p>
<p>麦克站在泰伦联邦的研发中心，眼前是一排排闪烁着蓝光的仪器和忙碌的科学家们。他的心中充满了对未知的敬畏，但他也明白，只有通过不断的战斗和牺牲，他才能找到真正的答案。新型武器的研发已经进入最后阶段，这是对抗异虫扩张的关键。</p>
<p>“麦克，你准备好了吗？”杰芬走过来，拍了拍他的肩膀。</p>
<p>“当然，杰芬。我们不能让这些异虫继续扩张下去。”麦克坚定地回答。</p>
<p>在接下来的几周里，麦克和杰芬与科学家们一起，日以继夜地工作，终于完成了新型武器的研发。这种武器能够有效地抑制异虫的繁殖和扩张，是泰伦联邦对抗异虫的最后希望。</p>
<p>最终战役的前夜，麦克站在指挥舰的甲板上，望着星空。他的心中充满了紧张和期待。他知道，明天的战斗将决定星际间的未来。</p>
<p>“麦克，你看起来很紧张。”泰伦联邦的高层走过来，关切地问道。</p>
<p>“是的，长官。这是我第一次面对如此大规模的战斗。”麦克坦诚地回答。</p>
<p>“记住，麦克，你不是一个人在战斗。我们都在你身边。”高层鼓励道。</p>
<p>第二天，战斗开始了。麦克和杰芬带领着他们的部队，冲向异虫的巢穴。新型武器发挥了巨大的作用，异虫的扩张被成功遏制。经过几个小时的激战，泰伦联邦取得了胜利。</p>
<p>战斗结束后，麦克站在战场上，望着满目疮痍的景象，心中充满了复杂的情感。他知道，这场胜利只是暂时的，真正的和平还需要更多的努力。</p>
<p>在星际间的和平协议签署仪式上，麦克被授予英雄的称号。他站在台上，望着台下的众人，心中充满了感慨。</p>
<p>“麦克，你成为了我们的英雄。”凯尔-莫拉联合体的领袖走上前来，微笑着说道。</p>
<p>“谢谢，但我只是做了我应该做的事情。”麦克谦虚地回答。</p>
<p>仪式结束后，麦克独自一人走在星际港口的甲板上，望着远处的星空。他反思着自己的战争经历，决定继续为和平而战。他知道，真正的答案还在前方，而他将继续追寻。</p>
</blockquote>
<h3 id="5-3-进一步思考和讨论"><a href="#5-3-进一步思考和讨论" class="headerlink" title="5.3 进一步思考和讨论"></a>5.3 进一步思考和讨论</h3><p>以下讨论点全部为开放性讨论，没有标准的正确答案，仅作为启发思考和开拓思路的作用</p>
<ul>
<li>使用LangGraph是否可以复现上面的工作流？</li>
<li>世界背景和故事线是否也可以引入人类讨论协作的机制？该怎么改写？</li>
<li>是否可以像翻译项目一样，引入反思机制？如果可以，反思机制应该如何设计？</li>
<li>还有没有更好的故事创作工作流设计？</li>
<li>你还有哪些好的工作流点子？学完本课之后，还有哪些创作难点？</li>
</ul>
<h2 id="6-其他信息"><a href="#6-其他信息" class="headerlink" title="6 其他信息"></a>6 其他信息</h2><ul>
<li>Mermaid在线渲染网站：<a target="_blank" rel="noopener" href="https://mermaid.live/">mermaid.live</a></li>
<li>手绘风格流程图在线编辑：<a target="_blank" rel="noopener" href="https://excalidraw.com/">excalidraw.com</a></li>
</ul>
<p>恢复环境：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 因为本课使用的langgraph可能需要依赖langchain <span class="number">0.2</span><span class="number">.10</span>版本，但其他课件依赖langchain <span class="number">0.1</span><span class="number">.20</span>版本</span><br><span class="line"># 请学习完本课之后对langchain进行降级，以免在其他课程出现运行错误</span><br><span class="line">!pip install langchain==<span class="number">0.1</span><span class="number">.20</span></span><br><span class="line">!pip install langchain-openai==<span class="number">0.1</span><span class="number">.6</span></span><br><span class="line">!pip install langchain-community==<span class="number">0.0</span><span class="number">.38</span></span><br></pre></td></tr></table></figure>

                
            </div>
            <hr/>

            



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/LLM/">
                                    <span class="chip bg-color">LLM</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;Previous</div>
            <div class="card">
                <a href="/2025/04/11/11-Transformer/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="11-Transformer">
                        
                        <span class="card-title">11-Transformer</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-04-11
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Tang
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/LLM/">
                        <span class="chip bg-color">LLM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                Next&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/04/06/09-Agent/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="09-Agent">
                        
                        <span class="card-title">09-Agent</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-04-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Tang
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/LLM/">
                        <span class="chip bg-color">LLM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;TOC</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('4'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024-2025</span>
            
            <a href="/about" target="_blank">Tang</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;Total visits:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;Total visitors:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/TangCharlotte/AI-Classes" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:485480375@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=485480375" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 485480375" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="https://www.zhihu.com/people/bu-yan-92-91" class="tooltipped" target="_blank" data-tooltip="关注我的知乎: https://www.zhihu.com/people/bu-yan-92-91" data-position="top" data-delay="50">
        <i class="fab fa-zhihu1">知</i>
    </a>



    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
